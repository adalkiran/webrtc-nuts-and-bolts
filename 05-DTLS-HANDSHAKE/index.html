
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A holistic way of understanding how WebRTC and its protocols run in practice, with code and detailed documentation.">
      
      
        <meta name="author" content="Adil Alper DALKIRAN">
      
      
        <link rel="canonical" href="https://adalkiran.github.io/webrtc-nuts-and-bolts/05-DTLS-HANDSHAKE/">
      
      
        <link rel="prev" href="../04-STUN-BINDING-REQUEST-FROM-CLIENT/">
      
      
        <link rel="next" href="../06-SRTP-INITIALIZATION/">
      
      
      <link rel="icon" href="../assets/icon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.35">
    
    
      
        <title>DTLS HANDSHAKE - WebRTC Nuts and Bolts</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.35f28582.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-05VMCF3NF0"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-05VMCF3NF0",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-05VMCF3NF0",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="DTLS HANDSHAKE - WebRTC Nuts and Bolts" >
      
        <meta  property="og:description"  content="A holistic way of understanding how WebRTC and its protocols run in practice, with code and detailed documentation." >
      
        <meta  property="og:image"  content="https://adalkiran.github.io/webrtc-nuts-and-bolts/assets/images/social/05-DTLS-HANDSHAKE.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://adalkiran.github.io/webrtc-nuts-and-bolts/05-DTLS-HANDSHAKE/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="DTLS HANDSHAKE - WebRTC Nuts and Bolts" >
      
        <meta  name="twitter:description"  content="A holistic way of understanding how WebRTC and its protocols run in practice, with code and detailed documentation." >
      
        <meta  name="twitter:image"  content="https://adalkiran.github.io/webrtc-nuts-and-bolts/assets/images/social/05-DTLS-HANDSHAKE.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#5-dtls-handshake" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="WebRTC Nuts and Bolts" class="md-header__button md-logo" aria-label="WebRTC Nuts and Bolts" data-md-component="logo">
      
  <img src="../assets/icon.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            WebRTC Nuts and Bolts
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              DTLS HANDSHAKE
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    adalkiran/webrtc-nuts-and-bolts
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../llama-nuts-and-bolts" class="md-tabs__link">
        
  
    
  
  LLaMA Nuts and Bolts

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href=".." class="md-tabs__link">
          
  
  WebRTC Nuts and Bolts

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="https://www.linkedin.com/in/alper-dalkiran/" class="md-tabs__link">
        
  
    
  
  Contact

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="WebRTC Nuts and Bolts" class="md-nav__button md-logo" aria-label="WebRTC Nuts and Bolts" data-md-component="logo">
      
  <img src="../assets/icon.svg" alt="logo">

    </a>
    WebRTC Nuts and Bolts
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    adalkiran/webrtc-nuts-and-bolts
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../llama-nuts-and-bolts" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LLaMA Nuts and Bolts
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    WebRTC Nuts and Bolts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            WebRTC Nuts and Bolts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HOME
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../00-INFRASTRUCTURE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    INFRASTRUCTURE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../01-RUNNING-IN-DEV-MODE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RUNNING IN DEVELOPMENT MODE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../02-BACKEND-INITIALIZATION/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BACKEND INITIALIZATION
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../03-FIRST-CLIENT-COMES-IN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FIRST CLIENT COMES IN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../04-STUN-BINDING-REQUEST-FROM-CLIENT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    STUN BINDING REQUEST FROM CLIENT
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    DTLS HANDSHAKE
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    DTLS HANDSHAKE
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#51-client-sends-first-clienthello-message-flight-0" class="md-nav__link">
    <span class="md-ellipsis">
      5.1. Client sends first ClientHello message (Flight 0)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#511-dtls-record-header" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.1. DTLS Record Header
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#512-dtls-record-header" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.2. DTLS Record Header
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#513-clienthello-message-content-flight-0" class="md-nav__link">
    <span class="md-ellipsis">
      5.1.3. ClientHello Message Content (Flight 0)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#52-server-sends-helloverifyrequest-message-flight-2" class="md-nav__link">
    <span class="md-ellipsis">
      5.2. Server sends HelloVerifyRequest message (Flight 2)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#53-client-sends-second-clienthello-message-flight-2" class="md-nav__link">
    <span class="md-ellipsis">
      5.3. Client sends second ClientHello message (Flight 2)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.3. Client sends second ClientHello message (Flight 2)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#531-generating-cryptographic-keys" class="md-nav__link">
    <span class="md-ellipsis">
      5.3.1. Generating cryptographic keys
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#54-server-sends-serverhello-message-flight-4" class="md-nav__link">
    <span class="md-ellipsis">
      5.4. Server sends ServerHello message (Flight 4)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#55-server-sends-certificate-message-flight-4" class="md-nav__link">
    <span class="md-ellipsis">
      5.5. Server sends Certificate message (Flight 4)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#56-server-sends-serverkeyexchange-message-flight-4" class="md-nav__link">
    <span class="md-ellipsis">
      5.6. Server sends ServerKeyExchange message (Flight 4)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#57-server-sends-certificaterequest-message-flight-4" class="md-nav__link">
    <span class="md-ellipsis">
      5.7. Server sends CertificateRequest message (Flight 4)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#58-server-sends-serverhellodone-message-flight-4" class="md-nav__link">
    <span class="md-ellipsis">
      5.8. Server sends ServerHelloDone message (Flight 4)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#59-client-sends-certificate-message-flight-4" class="md-nav__link">
    <span class="md-ellipsis">
      5.9. Client sends Certificate message (Flight 4)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#59-client-sends-clientkeyexchange-message-flight-4" class="md-nav__link">
    <span class="md-ellipsis">
      5.9. Client sends ClientKeyExchange message (Flight 4)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.9. Client sends ClientKeyExchange message (Flight 4)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#591-initialization-of-cipher-suite" class="md-nav__link">
    <span class="md-ellipsis">
      5.9.1. Initialization of cipher suite
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5.9.1. Initialization of cipher suite">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5911-generate-a-pre-master-secret" class="md-nav__link">
    <span class="md-ellipsis">
      5.9.1.1. Generate a Pre-Master Secret
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5912-generate-a-master-secret" class="md-nav__link">
    <span class="md-ellipsis">
      5.9.1.2. Generate a Master Secret
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5913-initialize-gcm" class="md-nav__link">
    <span class="md-ellipsis">
      5.9.1.3. Initialize GCM
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#510-client-sends-certificateverify-message-flight-4" class="md-nav__link">
    <span class="md-ellipsis">
      5.10. Client sends CertificateVerify message (Flight 4)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#511-client-sends-changecipherspec-message-flight-4" class="md-nav__link">
    <span class="md-ellipsis">
      5.11. Client sends ChangeCipherSpec message (Flight 4)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#512-client-sends-finished-message-flight-4" class="md-nav__link">
    <span class="md-ellipsis">
      5.12. Client sends Finished message (Flight 4)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#513-server-sends-changecipherspec-message-flight-6" class="md-nav__link">
    <span class="md-ellipsis">
      5.13. Server sends ChangeCipherSpec message (Flight 6)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#514-server-sends-finished-message-flight-6" class="md-nav__link">
    <span class="md-ellipsis">
      5.14. Server sends Finished message (Flight 6)
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../06-SRTP-INITIALIZATION/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SRTP INITIALIZATION
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../07-SRTP-PACKETS-COME/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SRTP PACKETS COME
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../08-VP8-PACKET-DECODE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VP8 PACKET DECODE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../09-CONCLUSION/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CONCLUSION
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.linkedin.com/in/alper-dalkiran/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contact
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="5-dtls-handshake"><strong>5. DTLS HANDSHAKE</strong><a class="headerlink" href="#5-dtls-handshake" title="Permanent link">&para;</a></h1>
<p>In previous chapter, we received first "expected" UDP packet (STUN Binding Request), then sent a STUN Binding Response as an answer. This means that, the client can start <a href="https://datatracker.ietf.org/doc/html/rfc4347#section-4.2" target="_blank">DTLS Handshake</a> process.</p>
<p><a href="https://en.wikipedia.org/wiki/Datagram_Transport_Layer_Security" target="_blank">DTLS (Datagram Transport Layer Security)</a> for secure handshake, authenticating each other, and crypto key exchange process. DTLS is similar to <a href="https://tr.wikipedia.org/wiki/Transport_Layer_Security" target="_blank">TLS (Transport Layer Security)</a>, DTLS runs over UDP instead of TCP. This project supports only DTLS v1.2.</p>
<p>DTLS Handshake consists of some "flights" between client and server, schematized <a href="https://tools.ietf.org/html/rfc4347#section-4.2.4" target="_blank">here</a> as:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="go">    ------                                          ------</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="go">    ClientHello             --------&gt;                           Flight 1</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="go">                            &lt;-------    HelloVerifyRequest      Flight 2</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="go">   ClientHello              --------&gt;                           Flight 3</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="go">                                               ServerHello    \</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="go">                                              Certificate*     \</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="go">                                        ServerKeyExchange*      Flight 4</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="go">                                       CertificateRequest*     /</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="go">                            &lt;--------      ServerHelloDone    /</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="go">    Certificate*                                              \</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="go">    ClientKeyExchange                                          \</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="go">    CertificateVerify*                                          Flight 5</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="go">    [ChangeCipherSpec]                                         /</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="go">    Finished                --------&gt;                         /</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="go">                                        [ChangeCipherSpec]    \ Flight 6</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="go">                            &lt;--------             Finished    /</span>
</span></code></pre></div>
<p>Sources:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=cuR05y_2Gxc&list=PLyqga7AXMtPMXgn1NwDqnSlgU05cnl4PA" target="_blank">Breaking Down the TLS Handshake</a> (Before continuing, it's highly recommended to watch this Youtube playlist to understand TLS Handshake process, ciphers, curves, hashing, algorithms, etc... In videos, they tell about TLS v1.2 and v1.3, but we don't use v1.3).</li>
</ul>
<h2 id="51-client-sends-first-clienthello-message-flight-0"><strong>5.1. Client sends first ClientHello message (Flight 0)</strong><a class="headerlink" href="#51-client-sends-first-clienthello-message-flight-0" title="Permanent link">&para;</a></h2>
<p>When a new packet comes in, the "AddBuffer" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/agent/udpclientsocket.go" target="_blank">backend/src/agent/udpclientsocket.go</a> looks for which protocol standard this packet to rely on.</p>
<p>In this context, we can check out dtls.IsDtlsPacket function. This function checks:</p>
<ul>
<li>Data length (arrayLen) is greater than zero
<br>and</li>
<li>First byte of data (ordinally) is between 20 and 63. This byte represents the DTLS Record Header's ContentType value.</li>
</ul>
<p>If this buffer part complies with these conditions, we can say "this packet is a DTLS protocol packet", then we can process it with DTLS protocol's methods.</p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/dtlsmessage.go" target="_blank">backend/src/dtls/dtlsmessage.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">IsDtlsPacket</span><span class="p">(</span><span class="nx">buf</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">arrayLen</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">arrayLen</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">buf</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">buf</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">63</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>Here is the console output when the server received an "expected" DTLS ClientHello message.</p>
<p><img alt="Received first ClientHello" src="../images/05-01-received-first-clienthello.png" style="max-width:75%"></img></p>
<p>We determined that this packet is DTLS packet. A DTLS packet consists of a Record Header and Content. If ContentType is "Handshake" (22), packet consists of Record Header, Handshake Header and Handshake Content.</p>
<p>The ClientHello packet we received is a "Handshake" message, so we should discuss the structure of a Handshake packet.</p>
<h2 id="511-dtls-record-header"><strong>5.1.1. DTLS Record Header</strong><a class="headerlink" href="#511-dtls-record-header" title="Permanent link">&para;</a></h2>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/recordheader.go" target="_blank">backend/src/dtls/recordheader.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">RecordHeader</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="nx">ContentType</span><span class="w">    </span><span class="nx">ContentType</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="nx">Version</span><span class="w">        </span><span class="nx">DtlsVersion</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="nx">Epoch</span><span class="w">          </span><span class="kt">uint16</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="nx">SequenceNumber</span><span class="w"> </span><span class="p">[</span><span class="nx">SequenceNumberSize</span><span class="p">]</span><span class="kt">byte</span><span class="w"> </span><span class="c1">//SequenceNumberSize: 6 (48 bit)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="nx">Length</span><span class="w">         </span><span class="kt">uint16</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>You can find:</p>
<ul>
<li>Detailed information about attributes of this record in <a href="https://webrtcforthecurious.com/docs/04-securing/#dtls" target="_blank">WebRTC for the Curious: Securing - DTLS</a></li>
<li>ContentType constants in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/recordheader.go" target="_blank">backend/src/stun/messagetype.go</a></li>
<li>DtlsVersion constants in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/recordheader.go" target="_blank">backend/src/stun/messagetype.go</a></li>
</ul>
<p>If Epoch is zero, the contents of the packet is in clear text, not encrypted. If not, contents are encrypted with the cipher suite which negotiated before while handshake proccess.</p>
<p>Source: <a href="https://github.com/eclipse/tinydtls/blob/706888256c3e03d9fcf1ec37bb1dd6499213be3c/dtls.h#L320" target="_blank">Generic header structure of the DTLS record layer</a></p>
<h2 id="512-dtls-record-header"><strong>5.1.2. DTLS Record Header</strong><a class="headerlink" href="#512-dtls-record-header" title="Permanent link">&para;</a></h2>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakeheader.go" target="_blank">backend/src/dtls/handshakeheader.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">HandshakeHeader</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="nx">HandshakeType</span><span class="w">   </span><span class="nx">HandshakeType</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="nx">Length</span><span class="w">          </span><span class="nx">uint24</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="nx">MessageSequence</span><span class="w"> </span><span class="kt">uint16</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="nx">FragmentOffset</span><span class="w">  </span><span class="nx">uint24</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="nx">FragmentLength</span><span class="w">  </span><span class="nx">uint24</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>You can find HandshakeType constants in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakeheader.go" target="_blank">backend/src/dtls/handshakeheader.go</a></li>
<li>"uint24" is defined in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/dtlsmessage.go" target="_blank">backend/src/dtls/dtlsmessage.go</a>, to represent 24 byte unsigned integer values in handshake data structure.</li>
</ul>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/dtlsmessage.go" target="_blank">backend/src/dtls/dtlsmessage.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">uint24</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kt">byte</span>
</span></code></pre></div>
<ul>
<li>MessageSequence: Message Sequence of Handshake Header (different from RecordHeader's SequenceNumber) should be kept in track incoming and outgoing handshake packets as "ClientSequenceNumber" and "ServerHandshakeSequenceNumber" in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakecontext.go" target="_blank">backend/src/dtls/handshakecontext.go</a></li>
<li><strong>DTLS Fragmentation:</strong> Handshake messages can be larger (larger than 1KB), e.g. can transmit a X.509 certificate data. In networking, there is a concept called <a href="https://en.wikipedia.org/wiki/Maximum_transmission_unit" target="_blank">MTU (Maximum Transmission Unit)</a> to optimize some tradeoffs explained <a href="https://en.wikipedia.org/wiki/Maximum_transmission_unit" target="_blank">here</a>. These principles require to split a larger packet into smaller pieces. These pieces can be transmitted in an unordered way. So we can track the order of the packets and completeness of them using FragmentOffset and FragmentLength information.
<br>
DTLS fragmentation is not supported in this project, so we ignore these fragmentation information.</li>
</ul>
<p>Source: <a href="https://github.com/eclipse/tinydtls/blob/706888256c3e03d9fcf1ec37bb1dd6499213be3c/dtls.h#L344" target="_blank">Header structure for the DTLS handshake protocol</a></p>
<h2 id="513-clienthello-message-content-flight-0"><strong>5.1.3. ClientHello Message Content (Flight 0)</strong><a class="headerlink" href="#513-clienthello-message-content-flight-0" title="Permanent link">&para;</a></h2>
<p>The ClientHello message is the first message of the first flight. The RFC counts flights starting from 1, we count them starting from 0, because we assume the Flight 0 is "waiting for ClientHello" state, Flight 1 is after receiving the first ClientHello. So, you can track the flight numbers this way. </p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/clienthello.go" target="_blank">backend/src/dtls/clienthello.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">ClientHello</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="nx">Version</span><span class="w">              </span><span class="nx">DtlsVersion</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="nx">Random</span><span class="w">               </span><span class="nx">Random</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="nx">Cookie</span><span class="w">               </span><span class="p">[]</span><span class="kt">byte</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="nx">SessionID</span><span class="w">            </span><span class="p">[]</span><span class="kt">byte</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="nx">CipherSuiteIDs</span><span class="w">       </span><span class="p">[]</span><span class="nx">CipherSuiteID</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="nx">CompressionMethodIDs</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="nx">Extensions</span><span class="w">           </span><span class="kd">map</span><span class="p">[</span><span class="nx">ExtensionType</span><span class="p">]</span><span class="nx">Extension</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="p">}</span>
</span></code></pre></div>
<details>
<summary>Click to expand Wireshark capture (Received): DTLS ClientHello (first, without cookie)</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="go">Frame 458: 189 bytes on wire (1512 bits), 189 bytes captured (1512 bits) on interface lo0, id 0</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="go">Null/Loopback</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="go">Internet Protocol Version 4, Src: 192.168.***.***, Dst: 192.168.***.***</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="go">User Datagram Protocol, Src Port: 52993, Dst Port: 15000</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="go">Datagram Transport Layer Security</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="go">    DTLSv1.2 Record Layer: Handshake Protocol: Client Hello</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="go">        Content Type: Handshake (22)</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="go">        Version: DTLS 1.0 (0xfeff)</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="go">        Epoch: 0</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="go">        Sequence Number: 0</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="go">        Length: 144</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="go">        Handshake Protocol: Client Hello</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="go">            Handshake Type: Client Hello (1)</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="go">            Length: 132</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="go">            Message Sequence: 0</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="go">            Fragment Offset: 0</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="go">            Fragment Length: 132</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="go">            Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="go">            Random: 78aa217a2ab532e840bf2f989d8f13ec4b66671e1cf1d8627eddd4917e51b31b</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="go">                GMT Unix Time: Feb 24, 2034 20:40:10.000000000 +03</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="go">                Random Bytes: 2ab532e840bf2f989d8f13ec4b66671e1cf1d8627eddd4917e51b31b</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="go">            Session ID Length: 0</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="go">            Cookie Length: 0</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="go">            Cipher Suites Length: 22</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="go">            Cipher Suites (11 suites)</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="go">                Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 (0xc02b)</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="go">                Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xc02f)</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="go">                Cipher Suite: TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256 (0xcca9)</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="go">                Cipher Suite: TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256 (0xcca8)</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="go">                Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA (0xc009)</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="go">                Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA (0xc013)</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="go">                Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA (0xc00a)</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="go">                Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA (0xc014)</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="go">                Cipher Suite: TLS_RSA_WITH_AES_128_GCM_SHA256 (0x009c)</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a><span class="go">                Cipher Suite: TLS_RSA_WITH_AES_128_CBC_SHA (0x002f)</span>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a><span class="go">                Cipher Suite: TLS_RSA_WITH_AES_256_CBC_SHA (0x0035)</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a><span class="go">            Compression Methods Length: 1</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a><span class="go">            Compression Methods (1 method)</span>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a><span class="go">                Compression Method: null (0)</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a><span class="go">            Extensions Length: 68</span>
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a><span class="go">            Extension: extended_master_secret (len=0)</span>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a><span class="go">                Type: extended_master_secret (23)</span>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a><span class="go">                Length: 0</span>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a><span class="go">            Extension: renegotiation_info (len=1)</span>
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a><span class="go">                Type: renegotiation_info (65281)</span>
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a><span class="go">                Length: 1</span>
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a><span class="go">                Renegotiation Info extension</span>
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a><span class="go">                    Renegotiation info extension length: 0</span>
</span><span id="__span-6-49"><a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a><span class="go">            Extension: supported_groups (len=8)</span>
</span><span id="__span-6-50"><a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a><span class="go">                Type: supported_groups (10)</span>
</span><span id="__span-6-51"><a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a><span class="go">                Length: 8</span>
</span><span id="__span-6-52"><a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a><span class="go">                Supported Groups List Length: 6</span>
</span><span id="__span-6-53"><a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a><span class="go">                Supported Groups (3 groups)</span>
</span><span id="__span-6-54"><a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a><span class="go">                    Supported Group: x25519 (0x001d)</span>
</span><span id="__span-6-55"><a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a><span class="go">                    Supported Group: secp256r1 (0x0017)</span>
</span><span id="__span-6-56"><a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a><span class="go">                    Supported Group: secp384r1 (0x0018)</span>
</span><span id="__span-6-57"><a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a><span class="go">            Extension: ec_point_formats (len=2)</span>
</span><span id="__span-6-58"><a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a><span class="go">                Type: ec_point_formats (11)</span>
</span><span id="__span-6-59"><a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a><span class="go">                Length: 2</span>
</span><span id="__span-6-60"><a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a><span class="go">                EC point formats Length: 1</span>
</span><span id="__span-6-61"><a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a><span class="go">                Elliptic curves point formats (1)</span>
</span><span id="__span-6-62"><a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a><span class="go">                    EC point format: uncompressed (0)</span>
</span><span id="__span-6-63"><a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a><span class="go">            Extension: session_ticket (len=0)</span>
</span><span id="__span-6-64"><a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a><span class="go">                Type: session_ticket (35)</span>
</span><span id="__span-6-65"><a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a><span class="go">                Length: 0</span>
</span><span id="__span-6-66"><a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a><span class="go">                Data (0 bytes)</span>
</span><span id="__span-6-67"><a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a><span class="go">            Extension: signature_algorithms (len=20)</span>
</span><span id="__span-6-68"><a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a><span class="go">                Type: signature_algorithms (13)</span>
</span><span id="__span-6-69"><a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a><span class="go">                Length: 20</span>
</span><span id="__span-6-70"><a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a><span class="go">                Signature Hash Algorithms Length: 18</span>
</span><span id="__span-6-71"><a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a><span class="go">                Signature Hash Algorithms (9 algorithms)</span>
</span><span id="__span-6-72"><a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a><span class="go">                    Signature Algorithm: ecdsa_secp256r1_sha256 (0x0403)</span>
</span><span id="__span-6-73"><a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a><span class="go">                        Signature Hash Algorithm Hash: SHA256 (4)</span>
</span><span id="__span-6-74"><a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a><span class="go">                        Signature Hash Algorithm Signature: ECDSA (3)</span>
</span><span id="__span-6-75"><a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a><span class="go">                    Signature Algorithm: rsa_pss_rsae_sha256 (0x0804)</span>
</span><span id="__span-6-76"><a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a><span class="go">                        Signature Hash Algorithm Hash: Unknown (8)</span>
</span><span id="__span-6-77"><a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a><span class="go">                        Signature Hash Algorithm Signature: SM2 (4)</span>
</span><span id="__span-6-78"><a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a><span class="go">                    Signature Algorithm: rsa_pkcs1_sha256 (0x0401)</span>
</span><span id="__span-6-79"><a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a><span class="go">                        Signature Hash Algorithm Hash: SHA256 (4)</span>
</span><span id="__span-6-80"><a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a><span class="go">                        Signature Hash Algorithm Signature: RSA (1)</span>
</span><span id="__span-6-81"><a id="__codelineno-6-81" name="__codelineno-6-81" href="#__codelineno-6-81"></a><span class="go">                    Signature Algorithm: ecdsa_secp384r1_sha384 (0x0503)</span>
</span><span id="__span-6-82"><a id="__codelineno-6-82" name="__codelineno-6-82" href="#__codelineno-6-82"></a><span class="go">                        Signature Hash Algorithm Hash: SHA384 (5)</span>
</span><span id="__span-6-83"><a id="__codelineno-6-83" name="__codelineno-6-83" href="#__codelineno-6-83"></a><span class="go">                        Signature Hash Algorithm Signature: ECDSA (3)</span>
</span><span id="__span-6-84"><a id="__codelineno-6-84" name="__codelineno-6-84" href="#__codelineno-6-84"></a><span class="go">                    Signature Algorithm: rsa_pss_rsae_sha384 (0x0805)</span>
</span><span id="__span-6-85"><a id="__codelineno-6-85" name="__codelineno-6-85" href="#__codelineno-6-85"></a><span class="go">                        Signature Hash Algorithm Hash: Unknown (8)</span>
</span><span id="__span-6-86"><a id="__codelineno-6-86" name="__codelineno-6-86" href="#__codelineno-6-86"></a><span class="go">                        Signature Hash Algorithm Signature: Unknown (5)</span>
</span><span id="__span-6-87"><a id="__codelineno-6-87" name="__codelineno-6-87" href="#__codelineno-6-87"></a><span class="go">                    Signature Algorithm: rsa_pkcs1_sha384 (0x0501)</span>
</span><span id="__span-6-88"><a id="__codelineno-6-88" name="__codelineno-6-88" href="#__codelineno-6-88"></a><span class="go">                        Signature Hash Algorithm Hash: SHA384 (5)</span>
</span><span id="__span-6-89"><a id="__codelineno-6-89" name="__codelineno-6-89" href="#__codelineno-6-89"></a><span class="go">                        Signature Hash Algorithm Signature: RSA (1)</span>
</span><span id="__span-6-90"><a id="__codelineno-6-90" name="__codelineno-6-90" href="#__codelineno-6-90"></a><span class="go">                    Signature Algorithm: rsa_pss_rsae_sha512 (0x0806)</span>
</span><span id="__span-6-91"><a id="__codelineno-6-91" name="__codelineno-6-91" href="#__codelineno-6-91"></a><span class="go">                        Signature Hash Algorithm Hash: Unknown (8)</span>
</span><span id="__span-6-92"><a id="__codelineno-6-92" name="__codelineno-6-92" href="#__codelineno-6-92"></a><span class="go">                        Signature Hash Algorithm Signature: Unknown (6)</span>
</span><span id="__span-6-93"><a id="__codelineno-6-93" name="__codelineno-6-93" href="#__codelineno-6-93"></a><span class="go">                    Signature Algorithm: rsa_pkcs1_sha512 (0x0601)</span>
</span><span id="__span-6-94"><a id="__codelineno-6-94" name="__codelineno-6-94" href="#__codelineno-6-94"></a><span class="go">                        Signature Hash Algorithm Hash: SHA512 (6)</span>
</span><span id="__span-6-95"><a id="__codelineno-6-95" name="__codelineno-6-95" href="#__codelineno-6-95"></a><span class="go">                        Signature Hash Algorithm Signature: RSA (1)</span>
</span><span id="__span-6-96"><a id="__codelineno-6-96" name="__codelineno-6-96" href="#__codelineno-6-96"></a><span class="go">                    Signature Algorithm: rsa_pkcs1_sha1 (0x0201)</span>
</span><span id="__span-6-97"><a id="__codelineno-6-97" name="__codelineno-6-97" href="#__codelineno-6-97"></a><span class="go">                        Signature Hash Algorithm Hash: SHA1 (2)</span>
</span><span id="__span-6-98"><a id="__codelineno-6-98" name="__codelineno-6-98" href="#__codelineno-6-98"></a><span class="go">                        Signature Hash Algorithm Signature: RSA (1)</span>
</span><span id="__span-6-99"><a id="__codelineno-6-99" name="__codelineno-6-99" href="#__codelineno-6-99"></a><span class="go">            Extension: use_srtp (len=9)</span>
</span><span id="__span-6-100"><a id="__codelineno-6-100" name="__codelineno-6-100" href="#__codelineno-6-100"></a><span class="go">                Type: use_srtp (14)</span>
</span><span id="__span-6-101"><a id="__codelineno-6-101" name="__codelineno-6-101" href="#__codelineno-6-101"></a><span class="go">                Length: 9</span>
</span><span id="__span-6-102"><a id="__codelineno-6-102" name="__codelineno-6-102" href="#__codelineno-6-102"></a><span class="go">                SRTP Protection Profiles Length: 6</span>
</span><span id="__span-6-103"><a id="__codelineno-6-103" name="__codelineno-6-103" href="#__codelineno-6-103"></a><span class="go">                SRTP Protection Profile: SRTP_AES128_CM_HMAC_SHA1_80 (0x0001)</span>
</span><span id="__span-6-104"><a id="__codelineno-6-104" name="__codelineno-6-104" href="#__codelineno-6-104"></a><span class="go">                SRTP Protection Profile: SRTP_AEAD_AES_256_GCM (0x0008)</span>
</span><span id="__span-6-105"><a id="__codelineno-6-105" name="__codelineno-6-105" href="#__codelineno-6-105"></a><span class="go">                SRTP Protection Profile: SRTP_AEAD_AES_128_GCM (0x0007)</span>
</span><span id="__span-6-106"><a id="__codelineno-6-106" name="__codelineno-6-106" href="#__codelineno-6-106"></a><span class="go">                MKI Length: 0</span>
</span><span id="__span-6-107"><a id="__codelineno-6-107" name="__codelineno-6-107" href="#__codelineno-6-107"></a><span class="go">            [JA3 Fullstring: 65277,49195-49199-52393-52392-49161-49171-49162-49172-156-47-53,23-65281-10-11-35-13-14,29-23-24,0]</span>
</span><span id="__span-6-108"><a id="__codelineno-6-108" name="__codelineno-6-108" href="#__codelineno-6-108"></a><span class="go">            [JA3: c14667d7da3e6f7a7ab5519ef78c2452]</span>
</span></code></pre></div>
</details>
<p>This message is bootstrapper of a new DTLS Handshake process. Client says to us, "I want to make a DTLS handshake with you, these are my security data to share".</p>
<ul>
<li>Version: Same logic and structure with the Version of RecordHeader. Value can differ, for e.g. RecordHeader's version can be 1.0 but ClientHello's version can be 1.2.</li>
<li>Random: Each part (the client and the server) generates random values for themselves, we call them as "Client Random" and "Server Random". In DTLS v1.2, random byte array consists of 32 bytes. The first 4 bytes are for current system time, remaining 28 bytes are randomly generated. </li>
</ul>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/random.go" target="_blank">backend/src/dtls/random.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">Random</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">    </span><span class="nx">GMTUnixTime</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="nx">RandomBytes</span><span class="w"> </span><span class="p">[</span><span class="nx">RandomBytesLength</span><span class="p">]</span><span class="kt">byte</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>Source: <a href="https://github.com/pion/dtls/blob/b3e235f54b60ccc31aa10193807b5e8e394f17ff/pkg/protocol/handshake/random.go" target="_blank">Pion WebRTC: DTLS Random</a></p>
<ul>
<li>Cookie: Randomly generated 20 bytes. But in first flight, first ClientHello's Cookie is empty. The second one will come not empty, we will discuss further.</li>
<li>SessionID: We didn't use this data, pass empty array, at least in this project.</li>
<li>
<p>CipherSuiteIDs: Each party has implemented and supported a set of <a href="https://en.wikipedia.org/wiki/Cipher_suite" target="_blank">Cipher Suite</a>s, in DTLS and TLS each of them coded with uint16 constant value. With this information, the client informs us "I support these cipher suites, choose one of them which you support too, then we can continue using it."
<br>
A "Cipher Suite" is a set of algorithms, usually consists of a key exchange algorithm, a hash algorithm and signature/authentication algorithm. You can find cipher suites and values <a href="https://www.rfc-editor.org/rfc/rfc8422.html#section-6" target="_blank">here</a>, and our only one supported cipher suite constant at <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/ciphersuites.go" target="_blank">backend/src/dtls/ciphersuites.go</a>.</p>
</li>
<li>
<p>CompressionMethodIDs: We only support Uncompressed mode with value zero.</p>
</li>
<li>
<p>Extensions: Client can send a list of extension data with the ClientHello message. Some of them which we support:</p>
<ul>
<li>UseExtendedMasterSecret: In encryption, we use a "master secret". Each party generates their own "master secret" and don't share it with others. There are some ways to generate it, a standard way and an extended way. We will discuss about this, but if ClientHello contains a UseExtendedMasterSecret extension, it means "the client uses extended master secret generation method, you should use it too".</li>
<li>SupportedEllipticCurves (Supported Groups): Elliptic curve types that the client supports. We support only X25519. You can find further NamedCurve types <a href="https://www.rfc-editor.org/rfc/rfc8422.html#section-5.1.1" target="_blank">here</a>, and our only one supported Curve constant (X25519) at <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/ciphersuites.go" target="_blank">backend/src/dtls/ciphersuites.go</a>.</li>
<li>SupportedPointFormats: We only will use "Uncompressed" value</li>
<li>UseSRTP: In an unencrypted way, the media streaming is made with <a href="https://en.wikipedia.org/wiki/Real-time_Transport_Protocol" target="_blank">RTP (Real-time Transport Protocol)</a> without any encryption. But WebRTC mandates using an encryption mechanism in transportation. If RTP packets are encrypted and authenticated, we call it <a href="https://en.wikipedia.org/wiki/Secure_Real-time_Transport_Protocol" target="_blank">SRTP (Secure Real-time Transport Protocol)</a>.
<br>
This extension contains IDs of SRTP Protection Profiles which the client supports. We support only SRTPProtectionProfile_AEAD_AES_128_GCM. You can find further SRTP Protection profile types <a href="https://www.iana.org/assignments/srtp-protection/srtp-protection.xhtml" target="_blank">here</a>, and our only one supported profile constant (AEAD_AES_128_GCM) at <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/ciphersuites.go" target="_blank">backend/src/dtls/ciphersuites.go</a>.</li>
</ul>
<p><br><br>
After receiving the first ClientHello (which doesn't contain a Cookie value), we:</p>
<ul>
<li>Set our DTLS Handshake Context's (HandshakeContext defined in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakecontext.go" target="_blank">backend/src/dtls/handshakecontext.go</a>) state as "Connecting"</li>
<li>Set the context's ProtocolVersion as incoming ClientHello's Version. We should check it, but in this project we assume two parties speak with DTLS v1.2.</li>
<li>Generate a 20 bytes DTLS Cookie by calling "generateDtlsCookie" function, and set the context's Cookie property.</li>
<li>Set the context's Flight to "Flight 2"</li>
</ul>
</li>
</ul>
<h2 id="52-server-sends-helloverifyrequest-message-flight-2"><strong>5.2. Server sends HelloVerifyRequest message (Flight 2)</strong><a class="headerlink" href="#52-server-sends-helloverifyrequest-message-flight-2" title="Permanent link">&para;</a></h2>
<p>We generate a HelloVerifyRequest message by calling "createDtlsHelloVerifyRequest" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a>. We share the Cookie data which we generated previously (in context.Cookie) with the client.</p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/helloverifyrequest.go" target="_blank">backend/src/dtls/helloverifyrequest.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">HelloVerifyRequest</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="nx">Version</span><span class="w"> </span><span class="nx">DtlsVersion</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="nx">Cookie</span><span class="w">  </span><span class="p">[]</span><span class="kt">byte</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="p">}</span>
</span></code></pre></div>
<details>
<summary>Click to expand Wireshark capture (Sent): DTLS HelloVerifyRequest</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="go">Frame 483: 80 bytes on wire (640 bits), 80 bytes captured (640 bits) on interface lo0, id 0</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="go">Null/Loopback</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="go">Internet Protocol Version 4, Src: 192.168.***.***, Dst: 192.168.***.***</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="go">User Datagram Protocol, Src Port: 15000, Dst Port: 52993</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="go">Datagram Transport Layer Security</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="go">    DTLSv1.2 Record Layer: Handshake Protocol: Hello Verify Request</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="go">        Content Type: Handshake (22)</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="go">        Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="go">        Epoch: 0</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="go">        Sequence Number: 0</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="go">        Length: 35</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="go">        Handshake Protocol: Hello Verify Request</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="go">            Handshake Type: Hello Verify Request (3)</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="go">            Length: 23</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="go">            Message Sequence: 0</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="go">            Fragment Offset: 0</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="go">            Fragment Length: 23</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="go">            Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="go">            Cookie Length: 20</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="go">            Cookie: b130316a0e21459cd54d85062f2fb018c4f78be0</span>
</span></code></pre></div>
</details>
<p>Now we are waiting for another (nearly the same) ClientHello message, but with a Cookie that has the same value as our HelloVerifyRequest.</p>
<p><img alt="Sent HelloVerifyRequest" src="../images/05-02-sent-helloverifyrequest.png" style="max-width:75%"></img></p>
<h2 id="53-client-sends-second-clienthello-message-flight-2"><strong>5.3. Client sends second ClientHello message (Flight 2)</strong><a class="headerlink" href="#53-client-sends-second-clienthello-message-flight-2" title="Permanent link">&para;</a></h2>
<details>
<summary>Click to expand Wireshark capture (Received): DTLS ClientHello (second, with cookie)</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="go">Frame 484: 209 bytes on wire (1672 bits), 209 bytes captured (1672 bits) on interface lo0, id 0</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="go">Null/Loopback</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="go">Internet Protocol Version 4, Src: 192.168.***.***, Dst: 192.168.***.***</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="go">User Datagram Protocol, Src Port: 52993, Dst Port: 15000</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="go">Datagram Transport Layer Security</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="go">    DTLSv1.2 Record Layer: Handshake Protocol: Client Hello</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="go">        Content Type: Handshake (22)</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="go">        Version: DTLS 1.0 (0xfeff)</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="go">        Epoch: 0</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="go">        Sequence Number: 1</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="go">        Length: 164</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="go">        Handshake Protocol: Client Hello</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="go">            Handshake Type: Client Hello (1)</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="go">            Length: 152</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="go">            Message Sequence: 1</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="go">            Fragment Offset: 0</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="go">            Fragment Length: 152</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="go">            Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="go">            Random: 78aa217a2ab532e840bf2f989d8f13ec4b66671e1cf1d8627eddd4917e51b31b</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="go">                GMT Unix Time: Feb 24, 2034 20:40:10.000000000 +03</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="go">                Random Bytes: 2ab532e840bf2f989d8f13ec4b66671e1cf1d8627eddd4917e51b31b</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="go">            Session ID Length: 0</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="go">            Cookie Length: 20</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="go">            Cookie: b130316a0e21459cd54d85062f2fb018c4f78be0</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="go">            Cipher Suites Length: 22</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="go">            Cipher Suites (11 suites)</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="go">                Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 (0xc02b)</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="go">                Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xc02f)</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="go">                Cipher Suite: TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256 (0xcca9)</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="go">                Cipher Suite: TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256 (0xcca8)</span>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="go">                Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA (0xc009)</span>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a><span class="go">                Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA (0xc013)</span>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a><span class="go">                Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA (0xc00a)</span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a><span class="go">                Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA (0xc014)</span>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a><span class="go">                Cipher Suite: TLS_RSA_WITH_AES_128_GCM_SHA256 (0x009c)</span>
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a><span class="go">                Cipher Suite: TLS_RSA_WITH_AES_128_CBC_SHA (0x002f)</span>
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a><span class="go">                Cipher Suite: TLS_RSA_WITH_AES_256_CBC_SHA (0x0035)</span>
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a><span class="go">            Compression Methods Length: 1</span>
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a><span class="go">            Compression Methods (1 method)</span>
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a><span class="go">                Compression Method: null (0)</span>
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a><span class="go">            Extensions Length: 68</span>
</span><span id="__span-10-42"><a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a><span class="go">            Extension: extended_master_secret (len=0)</span>
</span><span id="__span-10-43"><a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a><span class="go">                Type: extended_master_secret (23)</span>
</span><span id="__span-10-44"><a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a><span class="go">                Length: 0</span>
</span><span id="__span-10-45"><a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a><span class="go">            Extension: renegotiation_info (len=1)</span>
</span><span id="__span-10-46"><a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a><span class="go">                Type: renegotiation_info (65281)</span>
</span><span id="__span-10-47"><a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a><span class="go">                Length: 1</span>
</span><span id="__span-10-48"><a id="__codelineno-10-48" name="__codelineno-10-48" href="#__codelineno-10-48"></a><span class="go">                Renegotiation Info extension</span>
</span><span id="__span-10-49"><a id="__codelineno-10-49" name="__codelineno-10-49" href="#__codelineno-10-49"></a><span class="go">                    Renegotiation info extension length: 0</span>
</span><span id="__span-10-50"><a id="__codelineno-10-50" name="__codelineno-10-50" href="#__codelineno-10-50"></a><span class="go">            Extension: supported_groups (len=8)</span>
</span><span id="__span-10-51"><a id="__codelineno-10-51" name="__codelineno-10-51" href="#__codelineno-10-51"></a><span class="go">                Type: supported_groups (10)</span>
</span><span id="__span-10-52"><a id="__codelineno-10-52" name="__codelineno-10-52" href="#__codelineno-10-52"></a><span class="go">                Length: 8</span>
</span><span id="__span-10-53"><a id="__codelineno-10-53" name="__codelineno-10-53" href="#__codelineno-10-53"></a><span class="go">                Supported Groups List Length: 6</span>
</span><span id="__span-10-54"><a id="__codelineno-10-54" name="__codelineno-10-54" href="#__codelineno-10-54"></a><span class="go">                Supported Groups (3 groups)</span>
</span><span id="__span-10-55"><a id="__codelineno-10-55" name="__codelineno-10-55" href="#__codelineno-10-55"></a><span class="go">                    Supported Group: x25519 (0x001d)</span>
</span><span id="__span-10-56"><a id="__codelineno-10-56" name="__codelineno-10-56" href="#__codelineno-10-56"></a><span class="go">                    Supported Group: secp256r1 (0x0017)</span>
</span><span id="__span-10-57"><a id="__codelineno-10-57" name="__codelineno-10-57" href="#__codelineno-10-57"></a><span class="go">                    Supported Group: secp384r1 (0x0018)</span>
</span><span id="__span-10-58"><a id="__codelineno-10-58" name="__codelineno-10-58" href="#__codelineno-10-58"></a><span class="go">            Extension: ec_point_formats (len=2)</span>
</span><span id="__span-10-59"><a id="__codelineno-10-59" name="__codelineno-10-59" href="#__codelineno-10-59"></a><span class="go">                Type: ec_point_formats (11)</span>
</span><span id="__span-10-60"><a id="__codelineno-10-60" name="__codelineno-10-60" href="#__codelineno-10-60"></a><span class="go">                Length: 2</span>
</span><span id="__span-10-61"><a id="__codelineno-10-61" name="__codelineno-10-61" href="#__codelineno-10-61"></a><span class="go">                EC point formats Length: 1</span>
</span><span id="__span-10-62"><a id="__codelineno-10-62" name="__codelineno-10-62" href="#__codelineno-10-62"></a><span class="go">                Elliptic curves point formats (1)</span>
</span><span id="__span-10-63"><a id="__codelineno-10-63" name="__codelineno-10-63" href="#__codelineno-10-63"></a><span class="go">                    EC point format: uncompressed (0)</span>
</span><span id="__span-10-64"><a id="__codelineno-10-64" name="__codelineno-10-64" href="#__codelineno-10-64"></a><span class="go">            Extension: session_ticket (len=0)</span>
</span><span id="__span-10-65"><a id="__codelineno-10-65" name="__codelineno-10-65" href="#__codelineno-10-65"></a><span class="go">                Type: session_ticket (35)</span>
</span><span id="__span-10-66"><a id="__codelineno-10-66" name="__codelineno-10-66" href="#__codelineno-10-66"></a><span class="go">                Length: 0</span>
</span><span id="__span-10-67"><a id="__codelineno-10-67" name="__codelineno-10-67" href="#__codelineno-10-67"></a><span class="go">                Data (0 bytes)</span>
</span><span id="__span-10-68"><a id="__codelineno-10-68" name="__codelineno-10-68" href="#__codelineno-10-68"></a><span class="go">            Extension: signature_algorithms (len=20)</span>
</span><span id="__span-10-69"><a id="__codelineno-10-69" name="__codelineno-10-69" href="#__codelineno-10-69"></a><span class="go">                Type: signature_algorithms (13)</span>
</span><span id="__span-10-70"><a id="__codelineno-10-70" name="__codelineno-10-70" href="#__codelineno-10-70"></a><span class="go">                Length: 20</span>
</span><span id="__span-10-71"><a id="__codelineno-10-71" name="__codelineno-10-71" href="#__codelineno-10-71"></a><span class="go">                Signature Hash Algorithms Length: 18</span>
</span><span id="__span-10-72"><a id="__codelineno-10-72" name="__codelineno-10-72" href="#__codelineno-10-72"></a><span class="go">                Signature Hash Algorithms (9 algorithms)</span>
</span><span id="__span-10-73"><a id="__codelineno-10-73" name="__codelineno-10-73" href="#__codelineno-10-73"></a><span class="go">                    Signature Algorithm: ecdsa_secp256r1_sha256 (0x0403)</span>
</span><span id="__span-10-74"><a id="__codelineno-10-74" name="__codelineno-10-74" href="#__codelineno-10-74"></a><span class="go">                        Signature Hash Algorithm Hash: SHA256 (4)</span>
</span><span id="__span-10-75"><a id="__codelineno-10-75" name="__codelineno-10-75" href="#__codelineno-10-75"></a><span class="go">                        Signature Hash Algorithm Signature: ECDSA (3)</span>
</span><span id="__span-10-76"><a id="__codelineno-10-76" name="__codelineno-10-76" href="#__codelineno-10-76"></a><span class="go">                    Signature Algorithm: rsa_pss_rsae_sha256 (0x0804)</span>
</span><span id="__span-10-77"><a id="__codelineno-10-77" name="__codelineno-10-77" href="#__codelineno-10-77"></a><span class="go">                        Signature Hash Algorithm Hash: Unknown (8)</span>
</span><span id="__span-10-78"><a id="__codelineno-10-78" name="__codelineno-10-78" href="#__codelineno-10-78"></a><span class="go">                        Signature Hash Algorithm Signature: SM2 (4)</span>
</span><span id="__span-10-79"><a id="__codelineno-10-79" name="__codelineno-10-79" href="#__codelineno-10-79"></a><span class="go">                    Signature Algorithm: rsa_pkcs1_sha256 (0x0401)</span>
</span><span id="__span-10-80"><a id="__codelineno-10-80" name="__codelineno-10-80" href="#__codelineno-10-80"></a><span class="go">                        Signature Hash Algorithm Hash: SHA256 (4)</span>
</span><span id="__span-10-81"><a id="__codelineno-10-81" name="__codelineno-10-81" href="#__codelineno-10-81"></a><span class="go">                        Signature Hash Algorithm Signature: RSA (1)</span>
</span><span id="__span-10-82"><a id="__codelineno-10-82" name="__codelineno-10-82" href="#__codelineno-10-82"></a><span class="go">                    Signature Algorithm: ecdsa_secp384r1_sha384 (0x0503)</span>
</span><span id="__span-10-83"><a id="__codelineno-10-83" name="__codelineno-10-83" href="#__codelineno-10-83"></a><span class="go">                        Signature Hash Algorithm Hash: SHA384 (5)</span>
</span><span id="__span-10-84"><a id="__codelineno-10-84" name="__codelineno-10-84" href="#__codelineno-10-84"></a><span class="go">                        Signature Hash Algorithm Signature: ECDSA (3)</span>
</span><span id="__span-10-85"><a id="__codelineno-10-85" name="__codelineno-10-85" href="#__codelineno-10-85"></a><span class="go">                    Signature Algorithm: rsa_pss_rsae_sha384 (0x0805)</span>
</span><span id="__span-10-86"><a id="__codelineno-10-86" name="__codelineno-10-86" href="#__codelineno-10-86"></a><span class="go">                        Signature Hash Algorithm Hash: Unknown (8)</span>
</span><span id="__span-10-87"><a id="__codelineno-10-87" name="__codelineno-10-87" href="#__codelineno-10-87"></a><span class="go">                        Signature Hash Algorithm Signature: Unknown (5)</span>
</span><span id="__span-10-88"><a id="__codelineno-10-88" name="__codelineno-10-88" href="#__codelineno-10-88"></a><span class="go">                    Signature Algorithm: rsa_pkcs1_sha384 (0x0501)</span>
</span><span id="__span-10-89"><a id="__codelineno-10-89" name="__codelineno-10-89" href="#__codelineno-10-89"></a><span class="go">                        Signature Hash Algorithm Hash: SHA384 (5)</span>
</span><span id="__span-10-90"><a id="__codelineno-10-90" name="__codelineno-10-90" href="#__codelineno-10-90"></a><span class="go">                        Signature Hash Algorithm Signature: RSA (1)</span>
</span><span id="__span-10-91"><a id="__codelineno-10-91" name="__codelineno-10-91" href="#__codelineno-10-91"></a><span class="go">                    Signature Algorithm: rsa_pss_rsae_sha512 (0x0806)</span>
</span><span id="__span-10-92"><a id="__codelineno-10-92" name="__codelineno-10-92" href="#__codelineno-10-92"></a><span class="go">                        Signature Hash Algorithm Hash: Unknown (8)</span>
</span><span id="__span-10-93"><a id="__codelineno-10-93" name="__codelineno-10-93" href="#__codelineno-10-93"></a><span class="go">                        Signature Hash Algorithm Signature: Unknown (6)</span>
</span><span id="__span-10-94"><a id="__codelineno-10-94" name="__codelineno-10-94" href="#__codelineno-10-94"></a><span class="go">                    Signature Algorithm: rsa_pkcs1_sha512 (0x0601)</span>
</span><span id="__span-10-95"><a id="__codelineno-10-95" name="__codelineno-10-95" href="#__codelineno-10-95"></a><span class="go">                        Signature Hash Algorithm Hash: SHA512 (6)</span>
</span><span id="__span-10-96"><a id="__codelineno-10-96" name="__codelineno-10-96" href="#__codelineno-10-96"></a><span class="go">                        Signature Hash Algorithm Signature: RSA (1)</span>
</span><span id="__span-10-97"><a id="__codelineno-10-97" name="__codelineno-10-97" href="#__codelineno-10-97"></a><span class="go">                    Signature Algorithm: rsa_pkcs1_sha1 (0x0201)</span>
</span><span id="__span-10-98"><a id="__codelineno-10-98" name="__codelineno-10-98" href="#__codelineno-10-98"></a><span class="go">                        Signature Hash Algorithm Hash: SHA1 (2)</span>
</span><span id="__span-10-99"><a id="__codelineno-10-99" name="__codelineno-10-99" href="#__codelineno-10-99"></a><span class="go">                        Signature Hash Algorithm Signature: RSA (1)</span>
</span><span id="__span-10-100"><a id="__codelineno-10-100" name="__codelineno-10-100" href="#__codelineno-10-100"></a><span class="go">            Extension: use_srtp (len=9)</span>
</span><span id="__span-10-101"><a id="__codelineno-10-101" name="__codelineno-10-101" href="#__codelineno-10-101"></a><span class="go">                Type: use_srtp (14)</span>
</span><span id="__span-10-102"><a id="__codelineno-10-102" name="__codelineno-10-102" href="#__codelineno-10-102"></a><span class="go">                Length: 9</span>
</span><span id="__span-10-103"><a id="__codelineno-10-103" name="__codelineno-10-103" href="#__codelineno-10-103"></a><span class="go">                SRTP Protection Profiles Length: 6</span>
</span><span id="__span-10-104"><a id="__codelineno-10-104" name="__codelineno-10-104" href="#__codelineno-10-104"></a><span class="go">                SRTP Protection Profile: SRTP_AES128_CM_HMAC_SHA1_80 (0x0001)</span>
</span><span id="__span-10-105"><a id="__codelineno-10-105" name="__codelineno-10-105" href="#__codelineno-10-105"></a><span class="go">                SRTP Protection Profile: SRTP_AEAD_AES_256_GCM (0x0008)</span>
</span><span id="__span-10-106"><a id="__codelineno-10-106" name="__codelineno-10-106" href="#__codelineno-10-106"></a><span class="go">                SRTP Protection Profile: SRTP_AEAD_AES_128_GCM (0x0007)</span>
</span><span id="__span-10-107"><a id="__codelineno-10-107" name="__codelineno-10-107" href="#__codelineno-10-107"></a><span class="go">                MKI Length: 0</span>
</span><span id="__span-10-108"><a id="__codelineno-10-108" name="__codelineno-10-108" href="#__codelineno-10-108"></a><span class="go">            [JA3 Fullstring: 65277,49195-49199-52393-52392-49161-49171-49162-49172-156-47-53,23-65281-10-11-35-13-14,29-23-24,0]</span>
</span><span id="__span-10-109"><a id="__codelineno-10-109" name="__codelineno-10-109" href="#__codelineno-10-109"></a><span class="go">            [JA3: c14667d7da3e6f7a7ab5519ef78c2452]</span>
</span></code></pre></div>
</details>
<p><img alt="Received second ClientHello" src="../images/05-03-received-second-clienthello.png" style="max-width:75%"></img></p>
<p>We received second ClientHello from the client, with nearl same content but with a Cookie.</p>
<p>We:</p>
<ul>
<li>Know we are in Flight 2, we check if the incoming ClientHello's Cookie value and we sent via HelloVerifyRequest (stored in our context object). If it is empty, we should return to Flight 0 state and wait for a new ClientHello message. If not empty, we should compare two values.</li>
<li>Find a cipher suite ID which mutually supported by each peer, via calling "negotiateOnCipherSuiteIDs" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a>, then set it to context.CipherSuite. In our example, negotiated on TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 (0xc02b) cipher suite.</li>
<li>Loop through ClientHello message's extensions. We process the known and supported ones, and ignore unknown ones. Tracking the order at console output below:<ul>
<li>UseSRTP extension found: Find an SRTP Protection Profile ID which mutually supported by each peer, via calling "negotiateOnSRTPProtectionProfiles" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a>, then set it to context.SRTPProtectionProfile. In our example, negotiated on SRTP_AEAD_AES_128_GCM (0x0007) protection profile.</li>
<li>UseExtendedMasterSecret extension found: We set context.UseExtendedMasterSecret = true, we will generate the master secret with extended way further.</li>
<li>SupportedEllipticCurves extension found: Find a Named Curve ID which mutually supported by each peer, via calling "negotiateOnCurves" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a>, then set it to context.Curve. In our example, negotiated on X25519 (0x001d) named curve.</li>
</ul>
</li>
</ul>
<p><img alt="Processed second ClientHello" src="../images/05-04-processed-second-clienthello.png" /></p>
<h3 id="531-generating-cryptographic-keys"><strong>5.3.1. Generating cryptographic keys</strong><a class="headerlink" href="#531-generating-cryptographic-keys" title="Permanent link">&para;</a></h3>
<p>Now, server chose one from each cryptographic methods, algorithms etc... which client offered as alternatives. The server knows which methods they will use while encrypting, the client will learn further. The server should generate some secrets and keys, for it's side.</p>
<p>We:</p>
<ul>
<li>Set incoming ClientHello.Random to context.ClientRandom</li>
<li>Generate a Server Random via calling "Generate" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/random.go" target="_blank">backend/src/dtls/random.go</a> and set it to context.ServerRandom.</li>
<li>Generate a server private and server public key, by using <a href="https://pkg.go.dev/golang.org/x/crypto@v0.0.0-20220411220226-7b82a4e95df4/curve25519" target="_blank">X25519 curve</a>, via calling "GenerateCurveKeypair" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a>. These private and public keys are different from and not related with previously generated Server Certificate keys.<ul>
<li>Randomly generate 32 bytes array of private key</li>
<li>Calculate the public key (32 bytes) by using <a href="https://pkg.go.dev/golang.org/x/crypto@v0.0.0-20220411220226-7b82a4e95df4/curve25519#ScalarBaseMult" target="_blank">curve25519.ScalarBaseMult</a></li>
</ul>
</li>
<li>Store these generated private key as context.ServerPrivateKey, public key as context.ServerPublicKey.</li>
<li>
<p>Generate the ServerKeySignature by calling "GenerateKeySignature" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a>.</p>
<ul>
<li>
<p>Generate a signed_params message (signed_params) which consists concatenating of (total 100 bytes) (checkout <a href="https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.3" target="_blank">signed_params enum</a>), via "generateValueKeyMessage" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a>:</p>
<ul>
<li>Client random (32 bytes)</li>
<li>Server random (32 bytes)</li>
<li>ECDH Params (4 bytes)<ul>
<li>[0]: NamedCurve (0x03)</li>
<li>[1:2]: X25519 (0x001d)</li>
<li>[3]: 32 (public key length)</li>
</ul>
</li>
<li>Public key (32 bytes)</li>
</ul>
</li>
<li>
<p>Calculate hash of the "signed_params message" via "hashAlgorithm.Execute" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/ciphersuites.go" target="_blank">backend/src/dtls/ciphersuites.go</a> by <a href="https://pkg.go.dev/crypto/sha256#Sum256" target="_blank">sha256.Sum256</a>, hashing result is 32 bytes</p>
</li>
<li>Sign the hash value via "privateKeyObj.Sign" by <a href="https://pkg.go.dev/crypto/ecdsa#PrivateKey.Sign" target="_blank">ecdsa privateKey.Sign</a>. Result is 72 bytes.
<br>
<strong>*Attention Note:</strong> We hash a byte array contains the context.ServerPublicKey, then sign the result via ServerCertificate.PrivateKey. Public key was generated via "GenerateCurveKeypair", ServerCertificate.PrivateKey was the ServerCertificate's PrivateKey.</li>
<li>We set this calculated signature to context.ServerKeySignature</li>
</ul>
</li>
</ul>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nx">context</span><span class="p">.</span><span class="nx">ServerKeySignature</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">GenerateKeySignature</span><span class="p">(</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">                </span><span class="nx">clientRandomBytes</span><span class="p">,</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">                </span><span class="nx">serverRandomBytes</span><span class="p">,</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">                </span><span class="nx">context</span><span class="p">.</span><span class="nx">ServerPublicKey</span><span class="p">,</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">                </span><span class="nx">context</span><span class="p">.</span><span class="nx">Curve</span><span class="p">,</span><span class="w"> </span><span class="c1">//x25519</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">                </span><span class="nx">ServerCertificate</span><span class="p">.</span><span class="nx">PrivateKey</span><span class="p">,</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">                </span><span class="nx">context</span><span class="p">.</span><span class="nx">CipherSuite</span><span class="p">.</span><span class="nx">HashAlgorithm</span><span class="p">)</span>
</span></code></pre></div>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">GenerateKeySignature</span><span class="p">(</span><span class="nx">clientRandom</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">serverRandom</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">publicKey</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">curve</span><span class="w"> </span><span class="nx">Curve</span><span class="p">,</span><span class="w"> </span><span class="nx">privateKey</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">PrivateKey</span><span class="p">,</span><span class="w"> </span><span class="nx">hashAlgorithm</span><span class="w"> </span><span class="nx">HashAlgorithm</span><span class="p">)</span><span class="w"> </span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">generateValueKeyMessage</span><span class="p">(</span><span class="nx">clientRandom</span><span class="p">,</span><span class="w"> </span><span class="nx">serverRandom</span><span class="p">,</span><span class="w"> </span><span class="nx">publicKey</span><span class="p">,</span><span class="w"> </span><span class="nx">curve</span><span class="p">)</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">privateKeyObj</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">privateKey</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">*</span><span class="nx">ecdsa</span><span class="p">.</span><span class="nx">PrivateKey</span><span class="p">:</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">        </span><span class="nx">hashed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">hashAlgorithm</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="c1">//SHA256 sum</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">        </span><span class="nx">logging</span><span class="p">.</span><span class="nx">Descf</span><span class="p">(</span><span class="nx">logging</span><span class="p">.</span><span class="nx">ProtoCRYPTO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;signed_params values hashed: &lt;u&gt;0x%x&lt;/u&gt; (&lt;u&gt;%d&lt;/u&gt; bytes)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">hashed</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">hashed</span><span class="p">))</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">        </span><span class="nx">signed</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">privateKeyObj</span><span class="p">.</span><span class="nx">Sign</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span><span class="w"> </span><span class="nx">hashed</span><span class="p">,</span><span class="w"> </span><span class="nx">hashAlgorithm</span><span class="p">.</span><span class="nx">CryptoHashType</span><span class="p">())</span><span class="w"> </span><span class="c1">//crypto.SHA256</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">        </span><span class="nx">logging</span><span class="p">.</span><span class="nx">Descf</span><span class="p">(</span><span class="nx">logging</span><span class="p">.</span><span class="nx">ProtoCRYPTO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;signed_params values signed (result will be called as ServerKeySignature): &lt;u&gt;0x%x&lt;/u&gt; (&lt;u&gt;%d&lt;/u&gt; bytes)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">signed</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">signed</span><span class="p">))</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">signed</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;not supported private key type&quot;</span><span class="p">)</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>Set the context's Flight to "Flight 4"</li>
</ul>
<p>Now we are ready to send a group of messages: A ServerHello, a Certificate, a ServerKeyExchange, a CertificateRequest, and a ServerHelloDone message. These messages can be sent in same packet (by fragmenting) or one by one. We prefer to send them individually, one by one.</p>
<p>Sources:</p>
<ul>
<li><a href="https://github.com/pion/dtls/blob/bee42643f57a7f9c85ee3aa6a45a4fa9811ed122/pkg/crypto/elliptic/elliptic.go#L70" target="_blank">Pion WebRTC: DTLS, Generating Elliptic Keypair</a></li>
</ul>
<h2 id="54-server-sends-serverhello-message-flight-4"><strong>5.4. Server sends ServerHello message (Flight 4)</strong><a class="headerlink" href="#54-server-sends-serverhello-message-flight-4" title="Permanent link">&para;</a></h2>
<p>We generate a ServerHello message by calling "createDtlsServerHello" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a>.</p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/serverhello.go" target="_blank">backend/src/dtls/serverhello.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">ServerHello</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="nx">Version</span><span class="w">   </span><span class="nx">DtlsVersion</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="nx">Random</span><span class="w">    </span><span class="nx">Random</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="nx">SessionID</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="nx">CipherSuiteID</span><span class="w">       </span><span class="nx">CipherSuiteID</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="nx">CompressionMethodID</span><span class="w"> </span><span class="kt">byte</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="nx">Extensions</span><span class="w">          </span><span class="kd">map</span><span class="p">[</span><span class="nx">ExtensionType</span><span class="p">]</span><span class="nx">Extension</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="p">}</span>
</span></code></pre></div>
<details>
<summary>Click to expand Wireshark capture (Sent): DTLS ServerHello</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="go">Frame 511: 121 bytes on wire (968 bits), 121 bytes captured (968 bits) on interface lo0, id 0</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="go">Null/Loopback</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="go">Internet Protocol Version 4, Src: 192.168.***.***, Dst: 192.168.***.***</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="go">User Datagram Protocol, Src Port: 15000, Dst Port: 52993</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="go">Datagram Transport Layer Security</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="go">    DTLSv1.2 Record Layer: Handshake Protocol: Server Hello</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="go">        Content Type: Handshake (22)</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="go">        Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="go">        Epoch: 0</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="go">        Sequence Number: 1</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="go">        Length: 76</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="go">        Handshake Protocol: Server Hello</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="go">            Handshake Type: Server Hello (2)</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="go">            Length: 64</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="go">            Message Sequence: 1</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="go">            Fragment Offset: 0</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="go">            Fragment Length: 64</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="go">            Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="go">            Random: 627ac5897ff551e05e567951d2b9258207f9bfaf75084047c1fdcca5faad5b64</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="go">                GMT Unix Time: May 10, 2022 23:05:29.000000000 +03</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="go">                Random Bytes: 7ff551e05e567951d2b9258207f9bfaf75084047c1fdcca5faad5b64</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a><span class="go">            Session ID Length: 0</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="go">            Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 (0xc02b)</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="go">            Compression Method: null (0)</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="go">            Extensions Length: 24</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="go">            Extension: renegotiation_info (len=1)</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="go">                Type: renegotiation_info (65281)</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="go">                Length: 1</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="go">                Renegotiation Info extension</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a><span class="go">                    Renegotiation info extension length: 0</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a><span class="go">            Extension: use_srtp (len=5)</span>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a><span class="go">                Type: use_srtp (14)</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a><span class="go">                Length: 5</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a><span class="go">                SRTP Protection Profiles Length: 2</span>
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a><span class="go">                SRTP Protection Profile: SRTP_AEAD_AES_128_GCM (0x0007)</span>
</span><span id="__span-14-36"><a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a><span class="go">                MKI Length: 0</span>
</span><span id="__span-14-37"><a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a><span class="go">            Extension: ec_point_formats (len=2)</span>
</span><span id="__span-14-38"><a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a><span class="go">                Type: ec_point_formats (11)</span>
</span><span id="__span-14-39"><a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a><span class="go">                Length: 2</span>
</span><span id="__span-14-40"><a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a><span class="go">                EC point formats Length: 1</span>
</span><span id="__span-14-41"><a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a><span class="go">                Elliptic curves point formats (1)</span>
</span><span id="__span-14-42"><a id="__codelineno-14-42" name="__codelineno-14-42" href="#__codelineno-14-42"></a><span class="go">                    EC point format: uncompressed (0)</span>
</span><span id="__span-14-43"><a id="__codelineno-14-43" name="__codelineno-14-43" href="#__codelineno-14-43"></a><span class="go">            Extension: extended_master_secret (len=0)</span>
</span><span id="__span-14-44"><a id="__codelineno-14-44" name="__codelineno-14-44" href="#__codelineno-14-44"></a><span class="go">                Type: extended_master_secret (23)</span>
</span><span id="__span-14-45"><a id="__codelineno-14-45" name="__codelineno-14-45" href="#__codelineno-14-45"></a><span class="go">                Length: 0</span>
</span><span id="__span-14-46"><a id="__codelineno-14-46" name="__codelineno-14-46" href="#__codelineno-14-46"></a><span class="go">            [JA3S Fullstring: 65277,49195,65281-14-11-23]</span>
</span><span id="__span-14-47"><a id="__codelineno-14-47" name="__codelineno-14-47" href="#__codelineno-14-47"></a><span class="go">            [JA3S: eeb7a12006b679344c81e682d2ae5951]</span>
</span></code></pre></div>
</details>
<ul>
<li>Set Version to context.ProtocolVersion</li>
<li>Set Random to context.ServerRandom</li>
<li>Set CipherSuiteID to context.CipherSuite.ID</li>
<li>Add UseExtendedMasterSecret extension if context.UseExtendedMasterSecret is true (ClientHello contains UseExtendedMasterSecret extension)</li>
<li>Add RenegotiationInfo extension (despite we don't support renegotiation)</li>
<li>Add UseSRTP extension with context.SRTPProtectionProfile value (SRTPProtectionProfile_AEAD_AES_128_GCM - 0x0007)</li>
<li>Add SupportedPointFormats extension with PointFormatUncompressed (default, zero) value</li>
</ul>
<p><img alt="Sent ServerHello" src="../images/05-05-sent-serverhello.png" style="width: 750px;max-width:75%;"></img></p>
<p>ServerHello message was sent.</p>
<h2 id="55-server-sends-certificate-message-flight-4"><strong>5.5. Server sends Certificate message (Flight 4)</strong><a class="headerlink" href="#55-server-sends-certificate-message-flight-4" title="Permanent link">&para;</a></h2>
<p>We generate a Certificate message by calling "createDtlsCertificate" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a>.</p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/certificate.go" target="_blank">backend/src/dtls/certificate.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">Certificate</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="nx">Certificates</span><span class="w"> </span><span class="p">[][]</span><span class="kt">byte</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="p">}</span>
</span></code></pre></div>
<details>
<summary>Click to expand Wireshark capture (Sent): DTLS Certificate</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="go">Frame 513: 483 bytes on wire (3864 bits), 483 bytes captured (3864 bits) on interface lo0, id 0</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="go">Null/Loopback</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="go">Internet Protocol Version 4, Src: 192.168.***.***, Dst: 192.168.***.***</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="go">User Datagram Protocol, Src Port: 15000, Dst Port: 52993</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="go">Datagram Transport Layer Security</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="go">    DTLSv1.2 Record Layer: Handshake Protocol: Certificate</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="go">        Content Type: Handshake (22)</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="go">        Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="go">        Epoch: 0</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="go">        Sequence Number: 2</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="go">        Length: 438</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="go">        Handshake Protocol: Certificate</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="go">            Handshake Type: Certificate (11)</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="go">            Length: 426</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="go">            Message Sequence: 2</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="go">            Fragment Offset: 0</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="go">            Fragment Length: 426</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="go">            Certificates Length: 423</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="go">            Certificates (423 bytes)</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="go">                Certificate Length: 420</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="go">                Certificate: 308201a030820146a0030201020211016d6af47768a9349159deffbcaaec2761300a0608 (id-at-commonName=WebRTC-Nuts-and-Bolts)</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="go">                    signedCertificate</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="go">                        version: v3 (2)</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="go">                        serialNumber: 0x016d6af47768a9349159deffbcaaec2761</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="go">                        signature (ecdsa-with-SHA256)</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="go">                            Algorithm Id: 1.2.840.10045.4.3.2 (ecdsa-with-SHA256)</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="go">                        issuer: rdnSequence (0)</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="go">                            rdnSequence: 1 item (id-at-commonName=WebRTC-Nuts-and-Bolts)</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="go">                                RDNSequence item: 1 item (id-at-commonName=WebRTC-Nuts-and-Bolts)</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a><span class="go">                                    RelativeDistinguishedName item (id-at-commonName=WebRTC-Nuts-and-Bolts)</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a><span class="go">                                        Id: 2.5.4.3 (id-at-commonName)</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="go">                                        DirectoryString: printableString (1)</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="go">                                            printableString: WebRTC-Nuts-and-Bolts</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a><span class="go">                        validity</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a><span class="go">                            notBefore: utcTime (0)</span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a><span class="go">                                utcTime: 2022-05-10 20:05:04 (UTC)</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a><span class="go">                            notAfter: utcTime (0)</span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a><span class="go">                                utcTime: 2022-11-06 20:05:04 (UTC)</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a><span class="go">                        subject: rdnSequence (0)</span>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a><span class="go">                            rdnSequence: 1 item (id-at-commonName=WebRTC-Nuts-and-Bolts)</span>
</span><span id="__span-16-41"><a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a><span class="go">                                RDNSequence item: 1 item (id-at-commonName=WebRTC-Nuts-and-Bolts)</span>
</span><span id="__span-16-42"><a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a><span class="go">                                    RelativeDistinguishedName item (id-at-commonName=WebRTC-Nuts-and-Bolts)</span>
</span><span id="__span-16-43"><a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a><span class="go">                                        Id: 2.5.4.3 (id-at-commonName)</span>
</span><span id="__span-16-44"><a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a><span class="go">                                        DirectoryString: printableString (1)</span>
</span><span id="__span-16-45"><a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a><span class="go">                                            printableString: WebRTC-Nuts-and-Bolts</span>
</span><span id="__span-16-46"><a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a><span class="go">                        subjectPublicKeyInfo</span>
</span><span id="__span-16-47"><a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a><span class="go">                            algorithm (id-ecPublicKey)</span>
</span><span id="__span-16-48"><a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a><span class="go">                                Algorithm Id: 1.2.840.10045.2.1 (id-ecPublicKey)</span>
</span><span id="__span-16-49"><a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a><span class="go">                                ECParameters: namedCurve (1)</span>
</span><span id="__span-16-50"><a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a><span class="go">                                    namedCurve: 1.2.840.10045.3.1.7 (secp256r1)</span>
</span><span id="__span-16-51"><a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a><span class="go">                            Padding: 0</span>
</span><span id="__span-16-52"><a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a><span class="go">                            subjectPublicKey: 0470c752a7ef812d4c99e2a776188a3ad2b38de6c794dd124fdce1317c2c0a57eb51a983</span>
</span><span id="__span-16-53"><a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a><span class="go">                        extensions: 4 items</span>
</span><span id="__span-16-54"><a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a><span class="go">                            Extension (id-ce-keyUsage)</span>
</span><span id="__span-16-55"><a id="__codelineno-16-55" name="__codelineno-16-55" href="#__codelineno-16-55"></a><span class="go">                                Extension Id: 2.5.29.15 (id-ce-keyUsage)</span>
</span><span id="__span-16-56"><a id="__codelineno-16-56" name="__codelineno-16-56" href="#__codelineno-16-56"></a><span class="go">                                critical: True</span>
</span><span id="__span-16-57"><a id="__codelineno-16-57" name="__codelineno-16-57" href="#__codelineno-16-57"></a><span class="go">                                Padding: 2</span>
</span><span id="__span-16-58"><a id="__codelineno-16-58" name="__codelineno-16-58" href="#__codelineno-16-58"></a><span class="go">                                KeyUsage: a4</span>
</span><span id="__span-16-59"><a id="__codelineno-16-59" name="__codelineno-16-59" href="#__codelineno-16-59"></a><span class="go">                                    1... .... = digitalSignature: True</span>
</span><span id="__span-16-60"><a id="__codelineno-16-60" name="__codelineno-16-60" href="#__codelineno-16-60"></a><span class="go">                                    .0.. .... = contentCommitment: False</span>
</span><span id="__span-16-61"><a id="__codelineno-16-61" name="__codelineno-16-61" href="#__codelineno-16-61"></a><span class="go">                                    ..1. .... = keyEncipherment: True</span>
</span><span id="__span-16-62"><a id="__codelineno-16-62" name="__codelineno-16-62" href="#__codelineno-16-62"></a><span class="go">                                    ...0 .... = dataEncipherment: False</span>
</span><span id="__span-16-63"><a id="__codelineno-16-63" name="__codelineno-16-63" href="#__codelineno-16-63"></a><span class="go">                                    .... 0... = keyAgreement: False</span>
</span><span id="__span-16-64"><a id="__codelineno-16-64" name="__codelineno-16-64" href="#__codelineno-16-64"></a><span class="go">                                    .... .1.. = keyCertSign: True</span>
</span><span id="__span-16-65"><a id="__codelineno-16-65" name="__codelineno-16-65" href="#__codelineno-16-65"></a><span class="go">                                    .... ..0. = cRLSign: False</span>
</span><span id="__span-16-66"><a id="__codelineno-16-66" name="__codelineno-16-66" href="#__codelineno-16-66"></a><span class="go">                                    .... ...0 = encipherOnly: False</span>
</span><span id="__span-16-67"><a id="__codelineno-16-67" name="__codelineno-16-67" href="#__codelineno-16-67"></a><span class="go">                                    0... .... = decipherOnly: False</span>
</span><span id="__span-16-68"><a id="__codelineno-16-68" name="__codelineno-16-68" href="#__codelineno-16-68"></a><span class="go">                            Extension (id-ce-extKeyUsage)</span>
</span><span id="__span-16-69"><a id="__codelineno-16-69" name="__codelineno-16-69" href="#__codelineno-16-69"></a><span class="go">                                Extension Id: 2.5.29.37 (id-ce-extKeyUsage)</span>
</span><span id="__span-16-70"><a id="__codelineno-16-70" name="__codelineno-16-70" href="#__codelineno-16-70"></a><span class="go">                                KeyPurposeIDs: 2 items</span>
</span><span id="__span-16-71"><a id="__codelineno-16-71" name="__codelineno-16-71" href="#__codelineno-16-71"></a><span class="go">                                    KeyPurposeId: 1.3.6.1.5.5.7.3.2 (id-kp-clientAuth)</span>
</span><span id="__span-16-72"><a id="__codelineno-16-72" name="__codelineno-16-72" href="#__codelineno-16-72"></a><span class="go">                                    KeyPurposeId: 1.3.6.1.5.5.7.3.1 (id-kp-serverAuth)</span>
</span><span id="__span-16-73"><a id="__codelineno-16-73" name="__codelineno-16-73" href="#__codelineno-16-73"></a><span class="go">                            Extension (id-ce-basicConstraints)</span>
</span><span id="__span-16-74"><a id="__codelineno-16-74" name="__codelineno-16-74" href="#__codelineno-16-74"></a><span class="go">                                Extension Id: 2.5.29.19 (id-ce-basicConstraints)</span>
</span><span id="__span-16-75"><a id="__codelineno-16-75" name="__codelineno-16-75" href="#__codelineno-16-75"></a><span class="go">                                critical: True</span>
</span><span id="__span-16-76"><a id="__codelineno-16-76" name="__codelineno-16-76" href="#__codelineno-16-76"></a><span class="go">                                BasicConstraintsSyntax</span>
</span><span id="__span-16-77"><a id="__codelineno-16-77" name="__codelineno-16-77" href="#__codelineno-16-77"></a><span class="go">                                    cA: True</span>
</span><span id="__span-16-78"><a id="__codelineno-16-78" name="__codelineno-16-78" href="#__codelineno-16-78"></a><span class="go">                            Extension (id-ce-subjectKeyIdentifier)</span>
</span><span id="__span-16-79"><a id="__codelineno-16-79" name="__codelineno-16-79" href="#__codelineno-16-79"></a><span class="go">                                Extension Id: 2.5.29.14 (id-ce-subjectKeyIdentifier)</span>
</span><span id="__span-16-80"><a id="__codelineno-16-80" name="__codelineno-16-80" href="#__codelineno-16-80"></a><span class="go">                                SubjectKeyIdentifier: ec5a0cc3ea06935d4482027434aae62cca6b8b8a</span>
</span><span id="__span-16-81"><a id="__codelineno-16-81" name="__codelineno-16-81" href="#__codelineno-16-81"></a><span class="go">                    algorithmIdentifier (ecdsa-with-SHA256)</span>
</span><span id="__span-16-82"><a id="__codelineno-16-82" name="__codelineno-16-82" href="#__codelineno-16-82"></a><span class="go">                        Algorithm Id: 1.2.840.10045.4.3.2 (ecdsa-with-SHA256)</span>
</span><span id="__span-16-83"><a id="__codelineno-16-83" name="__codelineno-16-83" href="#__codelineno-16-83"></a><span class="go">                    Padding: 0</span>
</span><span id="__span-16-84"><a id="__codelineno-16-84" name="__codelineno-16-84" href="#__codelineno-16-84"></a><span class="go">                    encrypted: 304502206b40cd413f21a016d5aa53325b2029e1a5ee3bddc2e49a9dadf97a5040718ff8</span>
</span></code></pre></div>
</details>
<ul>
<li>Set Certificates to ServerCertificate.Certificate</li>
</ul>
<p>We shared our X.509 Server Certificate data with the client.</p>
<p><img alt="Sent Certificate" src="../images/05-06-sent-certificate.png" style="width: 750px;max-width:75%;"></img></p>
<p>Certificate message was sent.</p>
<h2 id="56-server-sends-serverkeyexchange-message-flight-4"><strong>5.6. Server sends ServerKeyExchange message (Flight 4)</strong><a class="headerlink" href="#56-server-sends-serverkeyexchange-message-flight-4" title="Permanent link">&para;</a></h2>
<p>We generate a ServerKeyExchange message by calling "createDtlsServerKeyExchange" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a>.</p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/serverkeyexchange.go" target="_blank">backend/src/dtls/serverkeyexchange.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">ServerKeyExchange</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="nx">EllipticCurveType</span><span class="w"> </span><span class="nx">CurveType</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="nx">NamedCurve</span><span class="w">        </span><span class="nx">Curve</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">    </span><span class="nx">PublicKey</span><span class="w">         </span><span class="p">[]</span><span class="kt">byte</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">    </span><span class="nx">AlgoPair</span><span class="w">          </span><span class="nx">AlgoPair</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">    </span><span class="nx">Signature</span><span class="w">         </span><span class="p">[]</span><span class="kt">byte</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="p">}</span>
</span></code></pre></div>
<details>
<summary>Click to expand Wireshark capture (Sent): DTLS ServerKeyExchange</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="go">Frame 514: 169 bytes on wire (1352 bits), 169 bytes captured (1352 bits) on interface lo0, id 0</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="go">Null/Loopback</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="go">Internet Protocol Version 4, Src: 192.168.***.***, Dst: 192.168.***.***</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="go">User Datagram Protocol, Src Port: 15000, Dst Port: 52993</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="go">Datagram Transport Layer Security</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="go">    DTLSv1.2 Record Layer: Handshake Protocol: Server Key Exchange</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="go">        Content Type: Handshake (22)</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="go">        Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="go">        Epoch: 0</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="go">        Sequence Number: 3</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="go">        Length: 124</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="go">        Handshake Protocol: Server Key Exchange</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="go">            Handshake Type: Server Key Exchange (12)</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="go">            Length: 112</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="go">            Message Sequence: 3</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="go">            Fragment Offset: 0</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="go">            Fragment Length: 112</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="go">            EC Diffie-Hellman Server Params</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="go">                Curve Type: named_curve (0x03)</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="go">                Named Curve: x25519 (0x001d)</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="go">                Pubkey Length: 32</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="go">                Pubkey: 845dc25870655b8c2c93129b13a4308c375c74179d0de751852aa02a679e6557</span>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="go">                Signature Algorithm: ecdsa_secp256r1_sha256 (0x0403)</span>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="go">                    Signature Hash Algorithm Hash: SHA256 (4)</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="go">                    Signature Hash Algorithm Signature: ECDSA (3)</span>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="go">                Signature Length: 72</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="go">                Signature: 3046022100b8609b89a48945bee8ccad168c935466c2dcf46c8539bbf0f81ac6641e5db2</span>
</span></code></pre></div>
</details>
<ul>
<li>Set EllipticCurveType to context.CurveType (CurveTypeNamedCurve 0x03)</li>
<li>Set NamedCurve to context.Curve (CurveX25519 0x001d)</li>
<li>Set PublicKey to context.ServerPublicKey</li>
<li>Set AlgoPair to AlgoPair{
    <br>
    HashAlgorithm:      context.CipherSuite.HashAlgorithm <em>(HashAlgorithmSHA256 - 4)</em>
    <br>
    SignatureAlgorithm: context.CipherSuite.SignatureAlgorithm <em>(SignatureAlgorithmECDSA - 3)</em>
    <br>
    }</li>
<li>Set Signature to context.ServerKeySignature</li>
</ul>
<p><img alt="Sent ServerKeyExchange" src="../images/05-07-sent-serverkeyexchange.png" /></p>
<p>ServerKeyExchange message was sent.</p>
<h2 id="57-server-sends-certificaterequest-message-flight-4"><strong>5.7. Server sends CertificateRequest message (Flight 4)</strong><a class="headerlink" href="#57-server-sends-certificaterequest-message-flight-4" title="Permanent link">&para;</a></h2>
<p>We generate a CertificateRequest message by calling "createDtlsCertificateRequest" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a>.</p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/certificaterequest.go" target="_blank">backend/src/dtls/certificaterequest.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">CertificateRequest</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">    </span><span class="nx">CertificateTypes</span><span class="w"> </span><span class="p">[]</span><span class="nx">CertificateType</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="nx">AlgoPairs</span><span class="w">        </span><span class="p">[]</span><span class="nx">AlgoPair</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="p">}</span>
</span></code></pre></div>
<details>
<summary>Click to expand Wireshark capture (Sent): DTLS CertificateRequest</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="go">Frame 515: 65 bytes on wire (520 bits), 65 bytes captured (520 bits) on interface lo0, id 0</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="go">Null/Loopback</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="go">Internet Protocol Version 4, Src: 192.168.***.***, Dst: 192.168.***.***</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="go">User Datagram Protocol, Src Port: 15000, Dst Port: 52993</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="go">Datagram Transport Layer Security</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="go">    DTLSv1.2 Record Layer: Handshake Protocol: Certificate Request</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="go">        Content Type: Handshake (22)</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="go">        Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="go">        Epoch: 0</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="go">        Sequence Number: 4</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="go">        Length: 20</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="go">        Handshake Protocol: Certificate Request</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="go">            Handshake Type: Certificate Request (13)</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="go">            Length: 8</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="go">            Message Sequence: 4</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="go">            Fragment Offset: 0</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="go">            Fragment Length: 8</span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="go">            Certificate types count: 1</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="go">            Certificate types (1 type)</span>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="go">                Certificate type: ECDSA Sign (64)</span>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="go">            Signature Hash Algorithms Length: 2</span>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="go">            Signature Hash Algorithms (1 algorithm)</span>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="go">                Signature Algorithm: ecdsa_secp256r1_sha256 (0x0403)</span>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="go">                    Signature Hash Algorithm Hash: SHA256 (4)</span>
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="go">                    Signature Hash Algorithm Signature: ECDSA (3)</span>
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="go">            Distinguished Names Length: 0</span>
</span></code></pre></div>
</details>
<ul>
<li>Set CertificateTypes to [CertificateTypeECDSASign (0x40)]</li>
<li>Set AlgoPairs to [AlgoPair{
    <br>
    HashAlgorithm:      context.CipherSuite.HashAlgorithm <em>(HashAlgorithmSHA256 - 4)</em>
    <br>
    SignatureAlgorithm: context.CipherSuite.SignatureAlgorithm <em>(SignatureAlgorithmECDSA - 3)</em>
    <br>
    }]</li>
</ul>
<p>We requested for a client certificate which ECDSASign type, generated using hash algorithm SHA256 and signature algorithm ECDSA.</p>
<p><img alt="Sent CertificateRequest" src="../images/05-08-sent-certificaterequest.png" style="width: 750px;max-width:75%;"></img></p>
<p>CertificateRequest message was sent.</p>
<h2 id="58-server-sends-serverhellodone-message-flight-4"><strong>5.8. Server sends ServerHelloDone message (Flight 4)</strong><a class="headerlink" href="#58-server-sends-serverhellodone-message-flight-4" title="Permanent link">&para;</a></h2>
<p>We generate a ServerHelloDone message by calling "createDtlsServerHelloDone" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a>.</p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/serverhellodone.go" target="_blank">backend/src/dtls/serverhellodone.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">ServerHelloDone</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="p">}</span>
</span></code></pre></div>
<details>
<summary>Click to expand Wireshark capture (Sent): DTLS ServerHelloDone</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="go">Frame 516: 57 bytes on wire (456 bits), 57 bytes captured (456 bits) on interface lo0, id 0</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="go">Null/Loopback</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="go">Internet Protocol Version 4, Src: 192.168.***.***, Dst: 192.168.***.***</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="go">User Datagram Protocol, Src Port: 15000, Dst Port: 52993</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="go">Datagram Transport Layer Security</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="go">    DTLSv1.2 Record Layer: Handshake Protocol: Server Hello Done</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="go">        Content Type: Handshake (22)</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="go">        Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="go">        Epoch: 0</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="go">        Sequence Number: 5</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="go">        Length: 12</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="go">        Handshake Protocol: Server Hello Done</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="go">            Handshake Type: Server Hello Done (14)</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="go">            Length: 0</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="go">            Message Sequence: 5</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="go">            Fragment Offset: 0</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="go">            Fragment Length: 0</span>
</span></code></pre></div>
</details>
<p>The message doesn't carry any data.</p>
<p><img alt="Sent ServerHelloDone" src="../images/05-09-sent-serverhellodone.png" style="width: 750px;max-width:75%;"></img></p>
<p>ServerHelloDone message was sent.</p>
<p>Now we are waiting for a group of messages: A Certificate, a ClientKeyExchange, a CertificateVerify, a ChangeCipherSpec, a Finished message. For e.g., if our client is Chrome, it will send these messages in one packet.</p>
<h2 id="59-client-sends-certificate-message-flight-4"><strong>5.9. Client sends Certificate message (Flight 4)</strong><a class="headerlink" href="#59-client-sends-certificate-message-flight-4" title="Permanent link">&para;</a></h2>
<p><img alt="Received Certificate" src="../images/05-10-received-certificate.png" /></p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/certificate.go" target="_blank">backend/src/dtls/certificate.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">Certificate</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">    </span><span class="nx">Certificates</span><span class="w"> </span><span class="p">[][]</span><span class="kt">byte</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="p">}</span>
</span></code></pre></div>
<details>
<summary>Click to expand Wireshark capture (Received): DTLS Certificate (came in combined packet)</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="go">Frame 522: 579 bytes on wire (4632 bits), 579 bytes captured (4632 bits) on interface lo0, id 0</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="go">Null/Loopback</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="go">Internet Protocol Version 4, Src: 192.168.***.***, Dst: 192.168.***.***</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="go">User Datagram Protocol, Src Port: 52993, Dst Port: 15000</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="go">Datagram Transport Layer Security</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="go">    DTLSv1.2 Record Layer: Handshake Protocol: Certificate</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="go">        Content Type: Handshake (22)</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="go">        Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="go">        Epoch: 0</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="go">        Sequence Number: 2</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="go">        Length: 300</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="go">        Handshake Protocol: Certificate</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="go">            Handshake Type: Certificate (11)</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="go">            Length: 288</span>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="go">            Message Sequence: 2</span>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="go">            Fragment Offset: 0</span>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="go">            Fragment Length: 288</span>
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="go">            Certificates Length: 285</span>
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="go">            Certificates (285 bytes)</span>
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="go">                Certificate Length: 282</span>
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a><span class="go">                Certificate: 308201163081bda00302010202090087e9356f9f2916ea300a06082a8648ce3d04030230 (id-at-commonName=WebRTC)</span>
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="go">                    signedCertificate</span>
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="go">                        version: v3 (2)</span>
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a><span class="go">                        serialNumber: 0x0087e9356f9f2916ea</span>
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a><span class="go">                        signature (ecdsa-with-SHA256)</span>
</span><span id="__span-24-26"><a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a><span class="go">                            Algorithm Id: 1.2.840.10045.4.3.2 (ecdsa-with-SHA256)</span>
</span><span id="__span-24-27"><a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a><span class="go">                        issuer: rdnSequence (0)</span>
</span><span id="__span-24-28"><a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a><span class="go">                            rdnSequence: 1 item (id-at-commonName=WebRTC)</span>
</span><span id="__span-24-29"><a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a><span class="go">                                RDNSequence item: 1 item (id-at-commonName=WebRTC)</span>
</span><span id="__span-24-30"><a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a><span class="go">                                    RelativeDistinguishedName item (id-at-commonName=WebRTC)</span>
</span><span id="__span-24-31"><a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a><span class="go">                                        Id: 2.5.4.3 (id-at-commonName)</span>
</span><span id="__span-24-32"><a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a><span class="go">                                        DirectoryString: uTF8String (4)</span>
</span><span id="__span-24-33"><a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a><span class="go">                                            uTF8String: WebRTC</span>
</span><span id="__span-24-34"><a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a><span class="go">                        validity</span>
</span><span id="__span-24-35"><a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a><span class="go">                            notBefore: utcTime (0)</span>
</span><span id="__span-24-36"><a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a><span class="go">                                utcTime: 2022-05-09 20:05:26 (UTC)</span>
</span><span id="__span-24-37"><a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a><span class="go">                            notAfter: utcTime (0)</span>
</span><span id="__span-24-38"><a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a><span class="go">                                utcTime: 2022-06-09 20:05:26 (UTC)</span>
</span><span id="__span-24-39"><a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a><span class="go">                        subject: rdnSequence (0)</span>
</span><span id="__span-24-40"><a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a><span class="go">                            rdnSequence: 1 item (id-at-commonName=WebRTC)</span>
</span><span id="__span-24-41"><a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a><span class="go">                                RDNSequence item: 1 item (id-at-commonName=WebRTC)</span>
</span><span id="__span-24-42"><a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a><span class="go">                                    RelativeDistinguishedName item (id-at-commonName=WebRTC)</span>
</span><span id="__span-24-43"><a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a><span class="go">                                        Id: 2.5.4.3 (id-at-commonName)</span>
</span><span id="__span-24-44"><a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a><span class="go">                                        DirectoryString: uTF8String (4)</span>
</span><span id="__span-24-45"><a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a><span class="go">                                            uTF8String: WebRTC</span>
</span><span id="__span-24-46"><a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a><span class="go">                        subjectPublicKeyInfo</span>
</span><span id="__span-24-47"><a id="__codelineno-24-47" name="__codelineno-24-47" href="#__codelineno-24-47"></a><span class="go">                            algorithm (id-ecPublicKey)</span>
</span><span id="__span-24-48"><a id="__codelineno-24-48" name="__codelineno-24-48" href="#__codelineno-24-48"></a><span class="go">                                Algorithm Id: 1.2.840.10045.2.1 (id-ecPublicKey)</span>
</span><span id="__span-24-49"><a id="__codelineno-24-49" name="__codelineno-24-49" href="#__codelineno-24-49"></a><span class="go">                                ECParameters: namedCurve (1)</span>
</span><span id="__span-24-50"><a id="__codelineno-24-50" name="__codelineno-24-50" href="#__codelineno-24-50"></a><span class="go">                                    namedCurve: 1.2.840.10045.3.1.7 (secp256r1)</span>
</span><span id="__span-24-51"><a id="__codelineno-24-51" name="__codelineno-24-51" href="#__codelineno-24-51"></a><span class="go">                            Padding: 0</span>
</span><span id="__span-24-52"><a id="__codelineno-24-52" name="__codelineno-24-52" href="#__codelineno-24-52"></a><span class="go">                            subjectPublicKey: 0417529a3b477764073e1eade96bf4916c96db64f753d61de4dc7ade47799d8ee5899998</span>
</span><span id="__span-24-53"><a id="__codelineno-24-53" name="__codelineno-24-53" href="#__codelineno-24-53"></a><span class="go">                    algorithmIdentifier (ecdsa-with-SHA256)</span>
</span><span id="__span-24-54"><a id="__codelineno-24-54" name="__codelineno-24-54" href="#__codelineno-24-54"></a><span class="go">                        Algorithm Id: 1.2.840.10045.4.3.2 (ecdsa-with-SHA256)</span>
</span><span id="__span-24-55"><a id="__codelineno-24-55" name="__codelineno-24-55" href="#__codelineno-24-55"></a><span class="go">                    Padding: 0</span>
</span><span id="__span-24-56"><a id="__codelineno-24-56" name="__codelineno-24-56" href="#__codelineno-24-56"></a><span class="go">                    encrypted: 3045022100fe8422aaf94444773b82c63b20cd031afa23dd7feb4dcb0b2cf12132f04fd6</span>
</span><span id="__span-24-57"><a id="__codelineno-24-57" name="__codelineno-24-57" href="#__codelineno-24-57"></a>
</span><span id="__span-24-58"><a id="__codelineno-24-58" name="__codelineno-24-58" href="#__codelineno-24-58"></a><span class="go">...</span>
</span></code></pre></div>
</details>
<p>The client shared their X.509 Server Certificate data with the server. </p>
<ul>
<li>Set context.ClientCertificates to message.Certificates</li>
<li>Call "GetCertificateFingerprintFromBytes" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a> to generate the fingerprint hash from the certificate byte array</li>
<li>Compare the calculated fingerprint hash with context.ExpectedFingerprintHash which came with SDP data previously. So we can ensure that "the sender of SDP via Signaling" and "the sender of these handshake messages" are the same person/machine, not another man in the middle.</li>
</ul>
<h2 id="59-client-sends-clientkeyexchange-message-flight-4"><strong>5.9. Client sends ClientKeyExchange message (Flight 4)</strong><a class="headerlink" href="#59-client-sends-clientkeyexchange-message-flight-4" title="Permanent link">&para;</a></h2>
<p><img alt="Received ClientKeyExchange" src="../images/05-11-received-clientkeyexchange.png" /></p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/clientkeyexchange.go" target="_blank">backend/src/dtls/clientkeyexchange.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">ClientKeyExchange</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">    </span><span class="nx">PublicKey</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="p">}</span>
</span></code></pre></div>
<details>
<summary>Click to expand Wireshark capture (Received): DTLS ClientKeyExchange (came in combined packet)</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="go">Frame 522: 579 bytes on wire (4632 bits), 579 bytes captured (4632 bits) on interface lo0, id 0</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="go">Null/Loopback</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="go">Internet Protocol Version 4, Src: 192.168.***.***, Dst: 192.168.***.***</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="go">User Datagram Protocol, Src Port: 52993, Dst Port: 15000</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="go">Datagram Transport Layer Security</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="go">...</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="go">    DTLSv1.2 Record Layer: Handshake Protocol: Client Key Exchange</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="go">        Content Type: Handshake (22)</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="go">        Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="go">        Epoch: 0</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="go">        Sequence Number: 3</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="go">        Length: 45</span>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="go">        Handshake Protocol: Client Key Exchange</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="go">            Handshake Type: Client Key Exchange (16)</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="go">            Length: 33</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="go">            Message Sequence: 3</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="go">            Fragment Offset: 0</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="go">            Fragment Length: 33</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="go">            EC Diffie-Hellman Client Params</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="go">                Pubkey Length: 32</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="go">                Pubkey: 3377c79bef8cf1d25c9a3f9df5f8e4f5977147016afaa3c090dbfbf5f013007a</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="go">...</span>
</span></code></pre></div>
</details>
<ul>
<li>Set context.ClientKeyExchangePublic to message.PublicKey</li>
<li>If context.IsCipherSuiteInitialized is false (our cipher suite is not initialized yet), we are ready to initialize our cipher suite, call "initCipherSuite" function in from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a></li>
</ul>
<h3 id="591-initialization-of-cipher-suite"><strong>5.9.1. Initialization of cipher suite</strong><a class="headerlink" href="#591-initialization-of-cipher-suite" title="Permanent link">&para;</a></h3>
<p>We need to generate a master secret. Then using this master secret, client random, and server random, we will initialize our keys. We will use these keys while encrypting/decrypting the SRTP packets further.</p>
<h4 id="5911-generate-a-pre-master-secret"><strong>5.9.1.1. Generate a Pre-Master Secret</strong><a class="headerlink" href="#5911-generate-a-pre-master-secret" title="Permanent link">&para;</a></h4>
<p>We call "GeneratePreMasterSecret" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a></p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="w">    </span><span class="nx">preMasterSecret</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">GeneratePreMasterSecret</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">ClientKeyExchangePublic</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">ServerPrivateKey</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Curve</span><span class="p">)</span>
</span></code></pre></div>
<ul>
<li>Generate a byte array using the public key which came by ClientKeyExchange message, and our ServerPrivateKey via <a href="https://pkg.go.dev/golang.org/x/crypto@v0.0.0-20220411220226-7b82a4e95df4/curve25519#X25519" target="_blank">curve25519.X25519</a>. We call is as "pre-master key"
<br>
<strong>*Attention Note:</strong> Public key was the ClientKeyExchange message's Public Key, the ServerPrivateKey was generated via "GenerateCurveKeypair".</li>
</ul>
<p>Sources:</p>
<ul>
<li><a href="https://crypto.stackexchange.com/questions/27131/differences-between-the-terms-pre-master-secret-master-secret-private-key" target="_blank">Differences between the terms "pre-master secret", "master secret", "private key", and "shared secret"? (Stackoverflow)</a></li>
</ul>
<h4 id="5912-generate-a-master-secret"><strong>5.9.1.2. Generate a Master Secret</strong><a class="headerlink" href="#5912-generate-a-master-secret" title="Permanent link">&para;</a></h4>
<p>We look to our context.UseExtendedMasterSecret boolean value. Remember that, if ClientHello message has UseExtendedMasterSecret extension, we should generate our master secret in extended way.</p>
<p><strong>If context.UseExtendedMasterSecret is true:</strong></p>
<ul>
<li>
<p>Concatenate previous (sent and received) handshake messages as one byte array in a row via "concatHandshakeMessages" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a>. <br>
Don't forget that, we cached latest received and sent messages by handshake message types in <em>context.HandshakeMessagesReceived</em> and <em>context.HandshakeMessagesSent</em> maps.
<br>
Order should be like:</p>
<ul>
<li>ClientHello (recv)</li>
<li>ServerHello (sent)</li>
<li>Certificate (sent)</li>
<li>ServerKeyExchange (sent)</li>
<li>CertificateRequest (sent)</li>
<li>ServerHelloDone (sent)</li>
<li>Certificate (recv)</li>
<li>ClientKeyExchange (recv)</li>
</ul>
</li>
<li>
<p>In the screenshoot below (and also the screenshoot in chapter 5.9), we can see the concatenation result took <em>1179 bytes</em>.</p>
</li>
<li>Calculate hash of the "handshakeMessages" byte array via "hashAlgorithm.Execute" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/ciphersuites.go" target="_blank">backend/src/dtls/ciphersuites.go</a> by <a href="https://pkg.go.dev/crypto/sha256#Sum256" target="_blank">sha256.Sum256</a>, hashing result is 32 bytes. We call this value as "handshakeHash".</li>
<li>Call "GenerateExtendedMasterSecret" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a> with our <em>preMasterSecret</em>, <em>handshakeHash</em>, <em>context.CipherSuite.HashAlgorithm</em>.</li>
</ul>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">GenerateExtendedMasterSecret</span><span class="p">(</span><span class="nx">preMasterSecret</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">handshakeHash</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">hashAlgorithm</span><span class="w"> </span><span class="nx">HashAlgorithm</span><span class="p">)</span><span class="w"> </span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">    </span><span class="nx">seed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">append</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;extended master secret&quot;</span><span class="p">),</span><span class="w"> </span><span class="nx">handshakeHash</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">    </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">PHash</span><span class="p">(</span><span class="nx">preMasterSecret</span><span class="p">,</span><span class="w"> </span><span class="nx">seed</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">,</span><span class="w"> </span><span class="nx">hashAlgorithm</span><span class="p">)</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">    </span><span class="nx">logging</span><span class="p">.</span><span class="nx">Descf</span><span class="p">(</span><span class="nx">logging</span><span class="p">.</span><span class="nx">ProtoCRYPTO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Generated Extended MasterSecret using Pre-Master Secret, Handshake Hash via &lt;u&gt;%s&lt;/u&gt;: &lt;u&gt;0x%x&lt;/u&gt; (&lt;u&gt;%d bytes&lt;/u&gt;)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">hashAlgorithm</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">result</span><span class="p">))</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>
<p>In the "GenerateExtendedMasterSecret" function:</p>
<ul>
<li>Create the "seed" by concatenating "extended master secret" string value with our handshakeHash byte array. You can find details <a href="https://datatracker.ietf.org/doc/html/rfc7627#section-4" target="_blank">here</a>.</li>
<li>Call the "PHash" function <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a> to generate 48 bytes Extended Master Secret, which is calculated using our <strong>preMasterSecret</strong>, <strong>seed</strong> by <a href="https://pkg.go.dev/crypto/sha256#Sum256" target="_blank">sha256.Sum256</a>.
<br>
"PHash" function is a <a href="https://en.wikipedia.org/wiki/Pseudorandom_function_family" target="_blank">Pseudorandom Function (PRF)</a>, you can find further information <a href="https://en.wikipedia.org/wiki/Pseudorandom_function_family" target="_blank">here</a> and <a href="https://github.com/pion/dtls/blob/a6397ff7282bc56dc37a68ea9211702edb4de1de/pkg/crypto/prf/prf.go#L155" target="_blank">here</a>. This function returns a byte array with length the <em>requestedLength</em> parameter you gave. In this case, we gave <em>48</em> as <em>requestedLength</em>, it returned an array of 48 bytes.</li>
</ul>
</li>
<li>
<p>Set the result of "GenerateExtendedMasterSecret" function to context.ServerMasterSecret.</p>
</li>
</ul>
<p><img alt="Message concatenation result" src="../images/05-12-message-concatenation-result.png" /></p>
<p><strong>If context.UseExtendedMasterSecret is false:</strong></p>
<p><strong>Note:</strong> In current context, our code won't come this state, because (I think) Chrome always sends the UseExtendedMasterSecret extension with ClientHello message. But we can discuss on generating non-extended master secret:</p>
<ul>
<li>Call "GenerateMasterSecret" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a> with our <em>preMasterSecret</em>, <em>clientRandom</em>, <em>serverRandom</em>, <em>context.CipherSuite.HashAlgorithm</em>.</li>
<li>
<p>In the "GenerateMasterSecret" function:</p>
<ul>
<li>Create the "seed" by concatenating "master secret" string value, clientRandom and serverRandom.
<br>
<strong>Important note:</strong> The order of clientRandom and serverRandom is important, can vary by "being a client" or "being a server" as application.</li>
<li>Call the "PHash" function <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a> to generate 48 bytes Extended Master Secret, which is calculated using our <strong>preMasterSecret</strong>, <strong>seed</strong> by <a href="https://pkg.go.dev/crypto/sha256#Sum256" target="_blank">sha256.Sum256</a>.</li>
</ul>
</li>
<li>
<p>Set the result of "GenerateMasterSecret" function to context.ServerMasterSecret.</p>
</li>
</ul>
<p>Sources:</p>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7627#section-4" target="_blank">RFC 7627: Transport Layer Security (TLS) Session Hash and Extended Master Secret Extension - The Extended Master Secret</a></li>
<li><a href="https://webrtcforthecurious.com/docs/04-securing/#pseudorandom-function" target="_blank">WebRTC for the Curious: Securing - Pseudorandom Function</a></li>
<li><a href="https://en.wikipedia.org/wiki/Pseudorandom_function_family" target="_blank">Pseudorandom function family (Wikipedia)</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc4346#section-5" target="_blank">RFC 4346: The Transport Layer Security (TLS) Protocol Version 1.1 - HMAC and the Pseudorandom Function</a></li>
<li><a href="https://github.com/pion/dtls/blob/a6397ff7282bc56dc37a68ea9211702edb4de1de/pkg/crypto/prf/prf.go#L155" target="_blank">Pion WebRTC DTLS project, PHash function (Github)</a></li>
</ul>
<h4 id="5913-initialize-gcm"><strong>5.9.1.3. Initialize GCM</strong><a class="headerlink" href="#5913-initialize-gcm" title="Permanent link">&para;</a></h4>
<p><a href="https://en.wikipedia.org/wiki/Galois/Counter_Mode" target="_blank">GCM</a> is abbreviation for "Galois/Counter Mode" and is a type of <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation">block cipher mode of operation
</a>. In our project, we only implemented the TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 cipher suite, and it uses <a href="https://www.cryptosys.net/pki/manpki/pki_aesgcmauthencryption.html" target="_blank">AES-GCM</a> authenticated encryption.</p>
<p>So, we call the object that makes encryption/decryption over our DTLS Messages (if a message has encrypted) as GCM.</p>
<p>This struct was defined in "dtls" package specifically to process DTLS messages. We have another "GCM" struct in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/srtp/cryptogcm.go" target="_blank">backend/src/srtp/cryptogcm.go</a>, is different from this struct.</p>
<p>You can find the original code on <a href="https://github.com/pion/dtls/blob/b3e235f54b60ccc31aa10193807b5e8e394f17ff/pkg/crypto/ciphersuite/gcm.go#L20" target="_blank">Pion WebRTC DTLS project, GCM struct (Github)</a>.</p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/cryptogcm.go" target="_blank">backend/src/dtls/cryptogcm.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">GCM</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="w">    </span><span class="nx">localGCM</span><span class="p">,</span><span class="w"> </span><span class="nx">remoteGCM</span><span class="w">         </span><span class="nx">cipher</span><span class="p">.</span><span class="nx">AEAD</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">    </span><span class="nx">localWriteIV</span><span class="p">,</span><span class="w"> </span><span class="nx">remoteWriteIV</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>
<p>We call "InitGCM" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a> with our <em>context.ServerMasterSecret</em>, <em>clientRandom</em>, <em>serverRandom</em> and <em>context.CipherSuite</em>.</p>
</li>
<li>
<p>As you can see here on <a href="https://github.com/pion/dtls/blob/bee42643f57a7f9c85ee3aa6a45a4fa9811ed122/internal/ciphersuite/tls_ecdhe_ecdsa_with_aes_128_gcm_sha256.go#L77" target="_blank">Pion WebRTC DTLS project, TLSEcdheEcdsaWithAes128GcmSha256 Init function</a>, the cipher suite which we chose has these constant lengths:</p>
<ul>
<li>prfMacLen: 0 bytes</li>
<li>prfKeyLen: 16 bytes (our keys will be 16 bytes length)</li>
<li>prfIvLen: 4 bytes (our <a href="https://en.wikipedia.org/wiki/Initialization_vector" target="_blank">Initialization Vectors</a> will be 4 bytes length)
<br>
<strong>Note:</strong> These constant length values can vary for different cipher suites.</li>
</ul>
<p>Due to our chosen suite's MAC length is zero, we didn't include things related with MAC in our code.</p>
</li>
<li>
<p>Call "GenerateEncryptionKeys" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a>, you can find further information <a href="https://github.com/pion/dtls/blob/bee42643f57a7f9c85ee3aa6a45a4fa9811ed122/pkg/crypto/prf/prf.go#L199" target="_blank">here</a>.</p>
</li>
<li>
<p>Create the "seed" by concatenating "key expansion" string value,  serverRandom and clientRandom.
<br>
<strong>Important note:</strong> The order of clientRandom and serverRandom is important, can vary by "being a client" or "being a server" as application.</p>
</li>
<li>
<p>Generate a <a href="https://csrc.nist.gov/glossary/term/keying_material" target="_blank">keying material</a> by calling "PHash" function with requestedLength value (2 * keyLen) + (2 * ivLen).
<br>
Because we want:</p>
<ul>
<li>A key for client (clientWriteKey) (16 bytes)</li>
<li>A key for server (serverWriteKey) (16 bytes)</li>
<li>An initialization vector for client (clientWriteIV) (4 bytes)</li>
<li>An initialization vector for server (serverWriteIV) (4 bytes)</li>
</ul>
</li>
</ul>
<p>So we need (16+16+4+4) = 40 bytes array which is generated by PHash with our masterSecret and seed. Then we extract our key and IV values from these 40 bytes sequentially.</p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">GenerateEncryptionKeys</span><span class="p">(</span><span class="nx">masterSecret</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">clientRandom</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">serverRandom</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">keyLen</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">ivLen</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">hashAlgorithm</span><span class="w"> </span><span class="nx">HashAlgorithm</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">EncryptionKeys</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">    </span><span class="nx">logging</span><span class="p">.</span><span class="nx">Descf</span><span class="p">(</span><span class="nx">logging</span><span class="p">.</span><span class="nx">ProtoCRYPTO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Generating encryption keys with Key Length: &lt;u&gt;%d&lt;/u&gt;, IV Length: &lt;u&gt;%d&lt;/u&gt; via &lt;u&gt;%s&lt;/u&gt;, using Master Secret, Server Random, Client Random...&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">keyLen</span><span class="p">,</span><span class="w"> </span><span class="nx">ivLen</span><span class="p">,</span><span class="w"> </span><span class="nx">hashAlgorithm</span><span class="p">)</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">    </span><span class="nx">seed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nb">append</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;key expansion&quot;</span><span class="p">),</span><span class="w"> </span><span class="nx">serverRandom</span><span class="o">...</span><span class="p">),</span><span class="w"> </span><span class="nx">clientRandom</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">    </span><span class="nx">keyMaterial</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">PHash</span><span class="p">(</span><span class="nx">masterSecret</span><span class="p">,</span><span class="w"> </span><span class="nx">seed</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nx">keyLen</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nx">ivLen</span><span class="p">),</span><span class="w"> </span><span class="nx">hashAlgorithm</span><span class="p">)</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="w">    </span><span class="nx">clientWriteKey</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">keyMaterial</span><span class="p">[:</span><span class="nx">keyLen</span><span class="p">]</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="w">    </span><span class="nx">keyMaterial</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">keyMaterial</span><span class="p">[</span><span class="nx">keyLen</span><span class="p">:]</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="w">    </span><span class="nx">serverWriteKey</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">keyMaterial</span><span class="p">[:</span><span class="nx">keyLen</span><span class="p">]</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="w">    </span><span class="nx">keyMaterial</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">keyMaterial</span><span class="p">[</span><span class="nx">keyLen</span><span class="p">:]</span>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a><span class="w">    </span><span class="nx">clientWriteIV</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">keyMaterial</span><span class="p">[:</span><span class="nx">ivLen</span><span class="p">]</span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="w">    </span><span class="nx">keyMaterial</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">keyMaterial</span><span class="p">[</span><span class="nx">ivLen</span><span class="p">:]</span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a><span class="w">    </span><span class="nx">serverWriteIV</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">keyMaterial</span><span class="p">[:</span><span class="nx">ivLen</span><span class="p">]</span>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">EncryptionKeys</span><span class="p">{</span>
</span><span id="__span-30-21"><a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a><span class="w">        </span><span class="nx">MasterSecret</span><span class="p">:</span><span class="w">   </span><span class="nx">masterSecret</span><span class="p">,</span>
</span><span id="__span-30-22"><a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="w">        </span><span class="nx">ClientWriteKey</span><span class="p">:</span><span class="w"> </span><span class="nx">clientWriteKey</span><span class="p">,</span>
</span><span id="__span-30-23"><a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a><span class="w">        </span><span class="nx">ServerWriteKey</span><span class="p">:</span><span class="w"> </span><span class="nx">serverWriteKey</span><span class="p">,</span>
</span><span id="__span-30-24"><a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a><span class="w">        </span><span class="nx">ClientWriteIV</span><span class="p">:</span><span class="w">  </span><span class="nx">clientWriteIV</span><span class="p">,</span>
</span><span id="__span-30-25"><a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a><span class="w">        </span><span class="nx">ServerWriteIV</span><span class="p">:</span><span class="w">  </span><span class="nx">serverWriteIV</span><span class="p">,</span>
</span><span id="__span-30-26"><a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-30-27"><a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>You can find generated encryption keys below:</li>
</ul>
<p><img alt="Init GCM" src="../images/05-13-init-gcm.png" /></p>
<ul>
<li>Now, we have an "EncryptionKeys" object defined in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a>.
<br>
We are ready to create our GCM object, which contains our ciphers and IVs. We pass our key values to our "NewGCM" function.
<br>
<strong>Important note:</strong> The order of pairs (keys.ServerWriteKey, keys.ServerWriteIV) and (keys.ClientWriteKey, keys.ClientWriteIV) while passing them to "NewGCM" function below is important, can vary by "being a client" or "being a server" as application.</li>
<li>While creating our ciphers, we create new instances by <a href="https://pkg.go.dev/crypto/aes#NewCipher" target="_blank">aes.NewCipher</a> and <a href="https://pkg.go.dev/crypto/cipher#NewGCM" target="_blank">cipher.NewGCM</a></li>
</ul>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="w">    </span><span class="nx">gcm</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewGCM</span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">ServerWriteKey</span><span class="p">,</span><span class="w"> </span><span class="nx">keys</span><span class="p">.</span><span class="nx">ServerWriteIV</span><span class="p">,</span><span class="w"> </span><span class="nx">keys</span><span class="p">.</span><span class="nx">ClientWriteKey</span><span class="p">,</span><span class="w"> </span><span class="nx">keys</span><span class="p">.</span><span class="nx">ClientWriteIV</span><span class="p">)</span>
</span></code></pre></div>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/cryptogcm.go" target="_blank">backend/src/dtls/cryptogcm.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewGCM</span><span class="p">(</span><span class="nx">localKey</span><span class="p">,</span><span class="w"> </span><span class="nx">localWriteIV</span><span class="p">,</span><span class="w"> </span><span class="nx">remoteKey</span><span class="p">,</span><span class="w"> </span><span class="nx">remoteWriteIV</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">GCM</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="w">    </span><span class="nx">localBlock</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">aes</span><span class="p">.</span><span class="nx">NewCipher</span><span class="p">(</span><span class="nx">localKey</span><span class="p">)</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">    </span><span class="nx">localGCM</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cipher</span><span class="p">.</span><span class="nx">NewGCM</span><span class="p">(</span><span class="nx">localBlock</span><span class="p">)</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="w">    </span><span class="nx">remoteBlock</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">aes</span><span class="p">.</span><span class="nx">NewCipher</span><span class="p">(</span><span class="nx">remoteKey</span><span class="p">)</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="w">    </span><span class="nx">remoteGCM</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cipher</span><span class="p">.</span><span class="nx">NewGCM</span><span class="p">(</span><span class="nx">remoteBlock</span><span class="p">)</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">GCM</span><span class="p">{</span>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="w">        </span><span class="nx">localGCM</span><span class="p">:</span><span class="w">      </span><span class="nx">localGCM</span><span class="p">,</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="w">        </span><span class="nx">localWriteIV</span><span class="p">:</span><span class="w">  </span><span class="nx">localWriteIV</span><span class="p">,</span>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="w">        </span><span class="nx">remoteGCM</span><span class="p">:</span><span class="w">     </span><span class="nx">remoteGCM</span><span class="p">,</span>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="w">        </span><span class="nx">remoteWriteIV</span><span class="p">:</span><span class="w"> </span><span class="nx">remoteWriteIV</span><span class="p">,</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-32-17"><a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>We set returned GCM object to context.GCM and set context.IsCipherSuiteInitialized as true.</li>
</ul>
<p>Sources:</p>
<ul>
<li><a href="https://crypto.stackexchange.com/questions/3965/what-is-the-main-difference-between-a-key-an-iv-and-a-nonce" target="_blank">What is the main difference between a key, an IV and a nonce? (Stackoverflow)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Initialization_vector" target="_blank">Initialization vector</a></li>
<li><a href="https://csrc.nist.gov/glossary/term/keying_material" target="_blank">Keying material (NIST)</a></li>
<li><a href="https://csrc.nist.gov/glossary/term/secret_keying_material" target="_blank">Secret keying material (NIST)</a></li>
<li><a href="https://infosec.mozilla.org/guidelines/key_management#key-material" target="_blank">Key material (Mozilla)</a></li>
</ul>
<h2 id="510-client-sends-certificateverify-message-flight-4"><strong>5.10. Client sends CertificateVerify message (Flight 4)</strong><a class="headerlink" href="#510-client-sends-certificateverify-message-flight-4" title="Permanent link">&para;</a></h2>
<p><img alt="Received CertificateVerify" src="../images/05-14-received-certificateverify.png" /></p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/certificateverify.go" target="_blank">backend/src/dtls/certificateverify.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">CertificateVerify</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="w">    </span><span class="nx">AlgoPair</span><span class="w">  </span><span class="nx">AlgoPair</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="w">    </span><span class="nx">Signature</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="p">}</span>
</span></code></pre></div>
<details>
<summary>Click to expand Wireshark capture (Received): DTLS CertificateVerify (came in combined packet)</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="go">Frame 522: 579 bytes on wire (4632 bits), 579 bytes captured (4632 bits) on interface lo0, id 0</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="go">Null/Loopback</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="go">Internet Protocol Version 4, Src: 192.168.***.***, Dst: 192.168.***.***</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="go">User Datagram Protocol, Src Port: 52993, Dst Port: 15000</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="go">Datagram Transport Layer Security</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="go">...</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="go">    DTLSv1.2 Record Layer: Handshake Protocol: Certificate Verify</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="go">        Content Type: Handshake (22)</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="go">        Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="go">        Epoch: 0</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="go">        Sequence Number: 4</span>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a><span class="go">        Length: 88</span>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a><span class="go">        Handshake Protocol: Certificate Verify</span>
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a><span class="go">            Handshake Type: Certificate Verify (15)</span>
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a><span class="go">            Length: 76</span>
</span><span id="__span-34-18"><a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a><span class="go">            Message Sequence: 4</span>
</span><span id="__span-34-19"><a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a><span class="go">            Fragment Offset: 0</span>
</span><span id="__span-34-20"><a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a><span class="go">            Fragment Length: 76</span>
</span><span id="__span-34-21"><a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a><span class="go">            Signature Algorithm: ecdsa_secp256r1_sha256 (0x0403)</span>
</span><span id="__span-34-22"><a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a><span class="go">                Signature Hash Algorithm Hash: SHA256 (4)</span>
</span><span id="__span-34-23"><a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a><span class="go">                Signature Hash Algorithm Signature: ECDSA (3)</span>
</span><span id="__span-34-24"><a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a><span class="go">            Signature length: 72</span>
</span><span id="__span-34-25"><a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a><span class="go">            Signature: 30460221008002b23011ec9910f5af308336cbac1b48b6a011dc170ddbfe77dfb0b1a8a1</span>
</span><span id="__span-34-26"><a id="__codelineno-34-26" name="__codelineno-34-26" href="#__codelineno-34-26"></a>
</span><span id="__span-34-27"><a id="__codelineno-34-27" name="__codelineno-34-27" href="#__codelineno-34-27"></a><span class="go">...</span>
</span></code></pre></div>
</details>
<ul>
<li>Compare hash algorithm ID of incoming <em>message.AlgoPair.HashAlgorithm</em> and <em>context.CipherSuite.HashAlgorithm</em></li>
<li>Compare signature algorithm ID of incoming <em>message.AlgoPair.SignatureAlgorithm</em> and <em>context.CipherSuite.SignatureAlgorithm</em></li>
<li>
<p>Concatenate previous (sent and received) handshake messages as one byte array in a row via "concatHandshakeMessages" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a>. <br>
Order should be like:</p>
<ul>
<li>ClientHello (recv)</li>
<li>ServerHello (sent)</li>
<li>Certificate (sent)</li>
<li>ServerKeyExchange (sent)</li>
<li>CertificateRequest (sent)</li>
<li>ServerHelloDone (sent)</li>
<li>Certificate (recv)</li>
<li>ClientKeyExchange (recv)</li>
</ul>
</li>
<li>
<p>Call "VerifyCertificate" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a> with <em>concenated handshakeMessages</em>, <em>context.CipherSuite.HashAlgorithm</em>, <em>message.Signature</em>, <em>context.ClientCertificates</em></p>
</li>
<li>Unmarshall the ECDSA R and S values from the Signature of incoming CertificateVerify message by <a href="https://pkg.go.dev/encoding/asn1#Unmarshal" target="_blank">asn1.Unmarshal</a></li>
<li>Calculate hash of the "handshakeMessages" byte array via "hashAlgorithm.Execute" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/ciphersuites.go" target="_blank">backend/src/dtls/ciphersuites.go</a> by <a href="https://pkg.go.dev/crypto/sha256#Sum256" target="_blank">sha256.Sum256</a>, hashing result is 32 bytes. We call this value as "handshakeHash".</li>
<li>Check the validity of the X.509 certificate which came with Certificate message from the client, by <a href="https://pkg.go.dev/crypto/ecdsa#Verify" target="_blank">ecdsa.Verify</a>.</li>
</ul>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="nx">ecdsa</span><span class="p">.</span><span class="nx">Verify</span><span class="p">(</span><span class="nx">clientCertificatePublicKey</span><span class="p">,</span><span class="w"> </span><span class="nx">hash</span><span class="p">,</span><span class="w"> </span><span class="nx">ecdsaSign</span><span class="p">.</span><span class="nx">R</span><span class="p">,</span><span class="w"> </span><span class="nx">ecdsaSign</span><span class="p">.</span><span class="nx">S</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="511-client-sends-changecipherspec-message-flight-4"><strong>5.11. Client sends ChangeCipherSpec message (Flight 4)</strong><a class="headerlink" href="#511-client-sends-changecipherspec-message-flight-4" title="Permanent link">&para;</a></h2>
<p><img alt="Received ChangeCipherSpec" src="../images/05-15-received-changecipherspec.png" style="width: 750px;max-width:75%;"></img></p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/changecipherspec.go" target="_blank">backend/src/dtls/changecipherspec.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">ChangeCipherSpec</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="p">}</span>
</span></code></pre></div>
<details>
<summary>Click to expand Wireshark capture (Received): DTLS ChangeCipherSpec (came in combined packet)</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="go">Frame 522: 579 bytes on wire (4632 bits), 579 bytes captured (4632 bits) on interface lo0, id 0</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="go">Null/Loopback</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="go">Internet Protocol Version 4, Src: 192.168.***.***, Dst: 192.168.***.***</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="go">User Datagram Protocol, Src Port: 52993, Dst Port: 15000</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="go">Datagram Transport Layer Security</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="go">...</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="go">    DTLSv1.2 Record Layer: Change Cipher Spec Protocol: Change Cipher Spec</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="go">        Content Type: Change Cipher Spec (20)</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="go">        Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="go">        Epoch: 0</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="go">        Sequence Number: 5</span>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="go">        Length: 1</span>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="go">        Change Cipher Spec Message</span>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a>
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a><span class="go">...</span>
</span></code></pre></div>
</details>
<p>This type of message contains only a byte with value 1. We don't do anything for this message.</p>
<p><strong>Important note:</strong> Epoch of Record Header were 0 and contents were in clear text (not encrypted) until (and including) this ChangeCipherSpec message. But the messages that will come after this, will have Epoch with 1 and will be encrypted.</p>
<h2 id="512-client-sends-finished-message-flight-4"><strong>5.12. Client sends Finished message (Flight 4)</strong><a class="headerlink" href="#512-client-sends-finished-message-flight-4" title="Permanent link">&para;</a></h2>
<p><img alt="Received Finished" src="../images/05-16-received-finished.png" /></p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/finished.go" target="_blank">backend/src/dtls/finished.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">Finished</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="w">    </span><span class="nx">VerifyData</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="p">}</span>
</span></code></pre></div>
<details>
<summary>Click to expand Wireshark capture (Received): DTLS Finished (came in combined packet)</summary>
<p><strong>Important note:</strong> As you can see at the end of the block, latest handshake message (Finished) has Epoch: 1, and content was encrypted. Because of this, we can't see contents of it as clear text in Wireshark.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="go">Frame 522: 579 bytes on wire (4632 bits), 579 bytes captured (4632 bits) on interface lo0, id 0</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="go">Null/Loopback</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="go">Internet Protocol Version 4, Src: 192.168.***.***, Dst: 192.168.***.***</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="go">User Datagram Protocol, Src Port: 52993, Dst Port: 15000</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="go">Datagram Transport Layer Security</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="go">...</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="go">    Record Layer</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="go">        Content Type: Handshake (22)</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="go">        Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="go">        Epoch: 1</span>
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a><span class="go">        Sequence Number: 0</span>
</span><span id="__span-39-14"><a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a><span class="go">        Length: 48</span>
</span><span id="__span-39-15"><a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a><span class="go">        Handshake Protocol</span>
</span><span id="__span-39-16"><a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a><span class="gp gp-VirtualEnv">(Encrypted content: 0x0001000000000000e22c7b2609d96a7d3a98c7b80e32ea03868231eb419623ce8af27b5ab97b16df143e8743ab0cb6ba)</span>
</span></code></pre></div>
</details>
<p><strong>Important note:</strong> Epoch of Record Header is 1 and, this Finished message is the first message which was encrypted. If we can decode and decrypt contents of this message successfully, then verify the VerifyData successfully, it means that, the handshake process for our side succeeded! After that we will send two other messages, then it will be "completely" finished!</p>
<ul>
<li>
<p>Concatenate previous (sent and received) handshake messages as one byte array in a row via "concatHandshakeMessages" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a>. <br>
Order should be like (attention to CertificateVerify and Finished were addded despite previous concatenations):</p>
<ul>
<li>ClientHello (recv)</li>
<li>ServerHello (sent)</li>
<li>Certificate (sent)</li>
<li>ServerKeyExchange (sent)</li>
<li>CertificateRequest (sent)</li>
<li>ServerHelloDone (sent)</li>
<li>Certificate (recv)</li>
<li>ClientKeyExchange (recv)</li>
<li>CertificateVerify (recv)</li>
<li>Finished (recv)</li>
</ul>
</li>
<li>
<p>Call "VerifyFinishedData" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a> with <em>concenated handshakeMessages</em>, <em>context.ServerMasterSecret</em>, <em>context.CipherSuite.HashAlgorithm</em></p>
</li>
<li>Calculate hash of the "handshakeMessages" byte array via "hashAlgorithm.GetFunction" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/ciphersuites.go" target="_blank">backend/src/dtls/ciphersuites.go</a> by "Sum" function of the object created by <a href="https://pkg.go.dev/crypto/sha256#New" target="_blank">sha256.New</a>.</li>
<li>Create the "seed" by concatenating "server finished" string value with our handshakeHash byte array. You can find details <a href="https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.9" target="_blank">here</a>.</li>
<li>Call the "PHash" function <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/crypto.go" target="_blank">backend/src/dtls/crypto.go</a> to generate 12 bytes verify data, which is calculated using our <strong>context.ServerMasterSecret</strong>, <strong>seed</strong> by <a href="https://pkg.go.dev/crypto/sha256#Sum256" target="_blank">sha256.Sum256</a>. This data will be sent via Finished message further.</li>
<li>Set the context's Flight to "Flight 6"</li>
</ul>
<p>Sources:</p>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.9" target="_blank">RFC 5246: The Transport Layer Security (TLS) Protocol Version 1.2 - Finished</a></li>
</ul>
<h2 id="513-server-sends-changecipherspec-message-flight-6"><strong>5.13. Server sends ChangeCipherSpec message (Flight 6)</strong><a class="headerlink" href="#513-server-sends-changecipherspec-message-flight-6" title="Permanent link">&para;</a></h2>
<p>We generate a ChangeCipherSpec message by calling "createDtlsChangeCipherSpec" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a>.</p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/changecipherspec.go" target="_blank">backend/src/dtls/changecipherspec.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">ChangeCipherSpec</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="p">}</span>
</span></code></pre></div>
<details>
<summary>Click to expand Wireshark capture (Sent): DTLS ChangeCipherSpec</summary>
<div class="language-console highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="go">Frame 549: 46 bytes on wire (368 bits), 46 bytes captured (368 bits) on interface lo0, id 0</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="go">Null/Loopback</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="go">Internet Protocol Version 4, Src: 192.168.***.***, Dst: 192.168.***.***</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="go">User Datagram Protocol, Src Port: 15000, Dst Port: 52993</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="go">Datagram Transport Layer Security</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="go">    DTLSv1.2 Record Layer: Change Cipher Spec Protocol: Change Cipher Spec</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="go">        Content Type: Change Cipher Spec (20)</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="go">        Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="go">        Epoch: 0</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="go">        Sequence Number: 6</span>
</span><span id="__span-41-11"><a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="go">        Length: 1</span>
</span><span id="__span-41-12"><a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="go">        Change Cipher Spec Message</span>
</span></code></pre></div>
</details>
<p>This type of message contains only a byte with value 1.</p>
<p><strong>Important note:</strong> Epoch of Record Header were 0 and contents were in clear text (not encrypted) until (and including) this ChangeCipherSpec message. But the messages will be sent future, will have Epoch with 1, and will be encrypted.</p>
<p><img alt="Sent ChangeCipherSpec" src="../images/05-17-sent-changecipherspec.png" style="width: 750px;max-width:75%;"></img></p>
<ul>
<li>
<p>ChangeCipherSpec message was sent.</p>
</li>
<li>
<p>Called "IncreaseServerEpoch" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakecontext.go" target="_blank">backend/src/dtls/handshakecontext.go</a> to increase context.ServerEpoch to 1, and set context.ServerSequenceNumber = 0.</p>
</li>
</ul>
<h2 id="514-server-sends-finished-message-flight-6"><strong>5.14. Server sends Finished message (Flight 6)</strong><a class="headerlink" href="#514-server-sends-finished-message-flight-6" title="Permanent link">&para;</a></h2>
<p>We generate a Finished message by calling "createDtlsFinished" function in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakemanager.go" target="_blank">backend/src/dtls/handshakemanager.go</a>.</p>
<p><sup>from <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/finished.go" target="_blank">backend/src/dtls/finished.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">Finished</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="w">    </span><span class="nx">VerifyData</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="p">}</span>
</span></code></pre></div>
<details>
<summary>Click to expand Wireshark capture (Sent): DTLS Finished</summary>
<p><strong>Important note:</strong> As you can see at the end of the block, the handshake message (Finished) has Epoch: 1, and content was encrypted. Because of this, we can't see contents of it as clear text in Wireshark.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="go">Frame 550: 93 bytes on wire (744 bits), 93 bytes captured (744 bits) on interface lo0, id 0</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="go">Null/Loopback</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="go">Internet Protocol Version 4, Src: 192.168.***.***, Dst: 192.168.***.***</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="go">User Datagram Protocol, Src Port: 15000, Dst Port: 52993</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="go">Datagram Transport Layer Security</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="go">    Record Layer</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="go">        Content Type: Handshake (22)</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="go">        Version: DTLS 1.2 (0xfefd)</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="go">        Epoch: 1</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="go">        Sequence Number: 0</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="go">        Length: 48</span>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="go">        Handshake Protocol</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="gp gp-VirtualEnv">(Encrypted content: 0x61c244d15307ccaf237e2ef34fdd5bddff3d7d17cf3fcb837a80db65f777a2496c609b03d7a35b772754cc206bb16db2)</span>
</span></code></pre></div>
</details>
<p><img alt="Sent Finished" src="../images/05-18-sent-finished.png" style="max-width:75%;"></img></p>
<ul>
<li>Set VerifyData to calculatedVerifyData (calculated previously by calling "VerifyFinishedData" function)</li>
</ul>
<p><strong>Important note:</strong> We sent our first encrypted message successfully!</p>
<ul>
<li>Set our DTLS Handshake Context's (HandshakeContext defined in <a href="https://github.com/adalkiran/webrtc-nuts-and-bolts/blob/main/backend/src/dtls/handshakecontext.go" target="_blank">backend/src/dtls/handshakecontext.go</a>) state as "Connected"</li>
</ul>







  
  



  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../04-STUN-BINDING-REQUEST-FROM-CLIENT/" class="md-footer__link md-footer__link--prev" aria-label="Previous: STUN BINDING REQUEST FROM CLIENT">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                STUN BINDING REQUEST FROM CLIENT
              </div>
            </div>
          </a>
        
        
          
          <a href="../06-SRTP-INITIALIZATION/" class="md-footer__link md-footer__link--next" aria-label="Next: SRTP INITIALIZATION">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                SRTP INITIALIZATION
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 - present, Adil Alper DALKIRAN. All rights reserved.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/adalkiran" target="_blank" rel="noopener" title="adalkiran" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.linkedin.com/in/alper-dalkiran/" target="_blank" rel="noopener" title="@aadalkiran" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.linkedin.com/in/alper-dalkiran/" target="_blank" rel="noopener" title="in/alper-dalkiran" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["toc.follow", "toc.integrate", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "navigation.footer", "content.code.copy"], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.56dfad97.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>